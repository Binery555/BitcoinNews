<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>B Plus Gaing Momentum Break Core – Live Signals</title>

<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
  :root{
    --header-h:56px; /* dynamic header height for mobile */
    --bg:#0b0f14; --panel:#0f1621; --panel2:#0b1320; --ink:#e6eef7;
    --muted:#9eb1c7; --line:#1a2736;
    --up:#16a34a; --down:#ef4444;
  }
  body{
    margin:0; background:#020617; color:var(--ink);
    font-family:Inter,system-ui;
    overflow:hidden;
  }
  header{
    background:#020617;border-bottom:1px solid #1e293b;
    height:56px;
    padding:4px 10px;display:flex;align-items:center;gap:10px;
    box-sizing:border-box;
  }
  header h1{ font-size:15px;margin:0;color:#fff;font-weight:600; }
  select, button{
    background:#020617;color:#d5e2f0;border:1px solid #1e293b;
    padding:6px 8px;border-radius:8px;font-size:13px;
  }
  #status{
    font-size:11px;border-radius:999px;background:#020617;padding:3px 8px;
    color:#9eb1c7;border:1px solid #1e293b;margin-left:auto;
  }

  .btn-tp{ background:#2563eb; border-color:#1d4ed8; color:#e0f2fe; font-weight:500; }
  .btn-tp:hover{ background:#1d4ed8; }
  .btn-signal-settings{ background:#16a34a; border-color:#15803d; color:#ecfdf5; font-weight:500; }
  .btn-signal-settings:hover{ background:#15803d; }

  #layout{
    display:flex; flex-direction:column;
    height:calc(100dvh - var(--header-h,56px));
    width:100vw; min-height:0;
  }
  #top-row{ flex:1; min-height:0; display:flex; width:100%; }

  /* ========= bottom indicators = vertical stack + scroll ========= */
  #bottom-indicators{
    flex:0 0 38%;
    min-height:260px;
    max-height:56vh;
    border-top:1px solid #1e293b;
    background:#020817;
    padding:8px;
    box-sizing:border-box;
    overflow:auto;
  }
  .bi-row{
    display:flex;
    flex-direction:column;
    gap:10px;
    flex-wrap:nowrap;
    align-items:stretch;
  }
  .bi-card{
    flex:0 0 auto;
    width:100%;
    min-width:0;
    background:#0b1220;
    border:1px solid rgba(30,41,59,0.90);
    border-radius:12px;
    padding:10px;
    box-sizing:border-box;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .bi-title{font-size:12px; font-weight:800; color:#e5e7eb; letter-spacing:0.02em;}
  .bi-sub{font-size:11px; color:#94a3b8;}
  .bi-slot{ display:flex; align-items:center; justify-content:flex-start; padding:6px 0 0 0; }

  .bi-jet{ margin:0; }
  .bi-card.jetCard .bi-slot{justify-content:flex-start; padding-top:10px; overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch;}
  .bi-card.jetCard .chartind{overflow-x:auto; overflow-y:hidden; justify-content:flex-start;}

  #bottom-indicators .chartind{
    height:auto;
    min-height:0;
    max-height:none;
    border-top:none;
    background:transparent;
    padding:0;
    justify-content:center;
  }

  /* History card inside indicators */
  .histWrap{
    max-height:220px;
    overflow:auto;
    border-top:1px solid rgba(30,41,59,0.55);
    padding-top:8px;
    -webkit-overflow-scrolling:touch;
  }
  .histItem{
    border:1px solid rgba(31,41,55,0.8);
    background:rgba(2,6,23,0.55);
    border-radius:10px;
    padding:8px 9px;
    margin-bottom:8px;
  }
  .histTop{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .histSym{
    font-size:11px;
    font-weight:800;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(30,41,59,0.95);
    background:#020617;
    color:#e5e7eb;
  }
  .histDirBuy{ color:#4ade80; font-weight:900; font-size:12px; }
  .histDirSell{ color:#f87171; font-weight:900; font-size:12px; }
  .histDirClose{ color:#fbbf24; font-weight:900; font-size:12px; }
  .histMeta{ font-size:11px; color:#94a3b8; margin-top:4px; line-height:1.25; }

  #chart-wrap{ flex:1; min-width:0; height:100%; }
  #chart-grid{
    height:100%;
    display:flex;
    flex-direction:column;
    gap:10px;
    padding:10px;
    box-sizing:border-box;
  }

  /* legacy grid rows (kept; can be disabled by overrides below) */
  #chart-row-top{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    height:50%;
  }
  #chart-row-bottom{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:10px;
    height:50%;
  }
  #chart-row-top .chartbox,
  #chart-row-bottom .chartbox{ min-height:0; }

  .chartbox{
    background:#020617;
    border:1px solid #1e293b;
    border-radius:12px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-width:0;
    min-height:0;
  }
  .charthead{
    padding:6px 10px;
    font-size:12px;
    color:#cbd5e1;
    border-bottom:1px solid #1e293b;
    background:#0b1220;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .anglewrap{ display:flex; align-items:center; justify-content:flex-end; }
  .anglebadge{
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid #1e293b;
    background:#020617;
    color:#9eb1c7;
    white-space:nowrap;
  }
  .chartcanvas{ flex:1; min-height:0; }

  .chartsplit{ flex:1; min-height:0; display:flex; flex-direction:column; }
  .chartind{
    height:auto;
    min-height:80px;
    border-top:1px solid #1e293b;
    background:#0b1220;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:8px 10px;
    box-sizing:border-box;
  }

  .hTrack{
    position:relative;
    width:360px;
    max-width:100%;
    height:90px;
    border-radius:12px;
    border:1px solid rgba(30,41,59,0.95);
    background:rgba(2,6,23,0.45);
    overflow:hidden;
  }
  .hMid{
    position:absolute;
    left:0; right:0;
    top:50%;
    height:1px;
    background:rgba(148,163,184,0.25);
    transform:translateY(-0.5px);
  }
  .hCandle{
    position:absolute;
    left:10px;
    right:10px;
    top:50%;
    height:18px;
    transform:translateY(-50%);
    border-radius:10px;
    border:1px solid rgba(30,41,59,0.95);
    background:rgba(148,163,184,0.12);
    overflow:hidden;
  }
  .hFill{
    position:absolute;
    top:2px;
    bottom:2px;
    width:0%;
    left:0%;
    border-radius:8px;
    background:rgba(148,163,184,0.25);
    transition:width .15s ease, background-color .15s ease, opacity .15s ease;
  }

  .hMeta{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    width:360px;
    max-width:100%;
    padding:0 2px;
    margin-top:6px;
    box-sizing:border-box;
  }
  .tfTag{
    font-size:11px;
    font-weight:800;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(30,41,59,0.95);
    background:#020617;
    color:#e5e7eb;
  }
  .jetTag{font-size:12px;color:#cbd5e1;padding:2px 6px;border-radius:999px;border:1px solid rgba(148,163,184,0.25);}
  .pctTag{ font-size:11px; font-weight:800; color:#e5e7eb; letter-spacing:0.01em; }
  .pctSub{ font-size:11px; color:#94a3b8; margin-left:auto; }

  /* ========= 15m (jet) thinner/smaller ========= */
  .hTrack.jet{ width:620px; height:34px; }
  .hTrack.jet .hCandle{ height:14px; border-radius:8px; border-width:1px; }
  .hTrack.jet .hFill{ top:1px; bottom:1px; border-radius:6px; }

  #signals{
    width:280px;max-width:40vw;
    border-left:1px solid #1e293b;
    background:#020617;
    padding:8px;
    box-sizing:border-box;
    overflow-y:auto;
  }
  #signals-title{ font-size:13px; color:#e5e7eb; margin-bottom:6px; }
  .sig-card{
    border:1px solid #1f2937;
    border-radius:10px;
    padding:6px 7px;
    background:#020617;
    margin-bottom:6px;
  }
  .symbol{
    background:#020617;
    padding:2px 6px;
    border-radius:999px;
    margin-right:4px;
    font-size:11px;
    border:1px solid #1e293b;
    color:#cbd5f5;
  }
  .buy{ color:#4ade80; font-weight:600; font-size:12px;}
  .sell{ color:#f87171; font-weight:600; font-size:12px;}
  .close{ color:#fbbf24; font-weight:700; font-size:12px;}
  .price{ color:#e5e7eb; font-size:12px; }
  .tp{
    font-size:12px;
    margin-top:2px;
    border-radius:6px;
    padding:2px 4px;
    display:inline-block;
  }
  .time{ color:#64748b; font-size:11px; margin-top:2px; }

  /* ========= Toast supports true center without breaking animation ========= */
  #toast{
    position:fixed;
    background:transparent;
    border:none;
    padding:0;
    font-size:12px;
    color:#e5e7eb;
    box-shadow:none;

    opacity:0;
    pointer-events:none;
    transition:opacity .25s ease, transform .25s ease;
    z-index:9999;

    right:16px;
    bottom:16px;

    --toast-tx: 0px;  /* for centering */
    --toast-ty: 20px; /* entrance */
    transform: translate(var(--toast-tx), var(--toast-ty));
  }
  #toast.show{
    opacity:1;
    --toast-ty: 0px;
  }

  .toast-card{
    border-radius:14px;
    border:2px solid #1f2937;
    padding:10px 12px;
    background:#020617;
    min-width:260px;
    max-width:min(420px, 92vw);
    box-shadow:0 18px 50px rgba(0,0,0,0.55);
  }
  .toast-card .symbol{
    background:#020617;
    border:1px solid #1e293b;
    border-radius:999px;
    padding:2px 6px;
    margin-right:6px;
    font-size:11px;
    color:#cbd5f5;
  }
  .toast-title{ font-size:12px; color:#e5e7eb; }
  .toast-dir-buy{ color:#4ade80; font-weight:900; font-size:14px; margin-top:6px; }
  .toast-dir-sell{ color:#f87171; font-weight:900; font-size:14px; margin-top:6px; }
  .toast-entry{ color:#e5e7eb; font-size:12px; margin-top:6px; }
  .toast-tp{ font-size:11px; padding:2px 6px; border-radius:8px; display:inline-block; margin-top:6px; }
  .toast-time{ color:#94a3b8; font-size:11px; margin-top:6px; }

  @media (max-width: 900px){
    #layout{flex-direction:column;}
    #signals{
      width:100%;
      max-width:100%;
      height:40%;
      border-left:none;
      border-top:1px solid #1e293b;
    }
  }

  header{ position:sticky; top:0; z-index:10001; }

  @media (max-width: 700px){
    body{ overflow:hidden; }
    header{
      height:auto; padding:8px 10px;
      flex-wrap:wrap; gap:8px;
    }
    header h1{
      flex:1 1 100%;
      font-size:14px;
      line-height:1.2;
      text-align:center;
      margin-left:0;
    }
    header label{ font-size:11px; color:#94a3b8; }
    select, button{ font-size:12px; }

    #layout{ height:calc(100dvh - var(--header-h,56px)); overflow:hidden; }
    #top-row{ flex-direction:column; }

    #chart-wrap{
      flex:0 0 auto;
      height:54dvh;
      min-height:0;
      overflow:hidden;
    }

    /* legacy mobile grid (kept; may be overridden below) */
    #chart-grid{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: repeat(3, 1fr);
      gap:6px;
      padding:6px;
      box-sizing:border-box;
    }
    #chart-row-top,
    #chart-row-bottom{
      display:contents;
      height:auto;
    }
    .chartbox{ min-height:0; }
    .charthead{ padding:4px 6px; font-size:10px; }
    .chartcanvas{ min-height:0; }

    #signals{
      flex:0 0 auto;
      width:100%;
      max-width:100%;
      height:18dvh;
      border-left:none;
      border-top:2px solid #1e293b;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }

    /* indicators as vertical stack on mobile too */
    #bottom-indicators{
      flex:0 0 auto;
      height:28dvh;
      max-height:none;
      padding:6px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      box-sizing:border-box;
    }
    .bi-row{ flex-direction:column; gap:8px; }
    #bottom-indicators .bi-card{ width:100%; min-width:0; padding:8px; }
    #bottom-indicators .bi-card.jetCard{ width:100%; min-width:0; max-width:none; }
    #bottom-indicators .bi-title{font-size:12px;}
    #bottom-indicators .bi-sub{font-size:10px; line-height:1.25;}
    #bottom-indicators .bi-slot{padding-top:6px;}
    #bottom-indicators .chartind{max-height:70px;}

    .hTrack{ height:48px; }
    .hTrack.jet{ width:100%; height:28px; }
    .hTrack.jet .hCandle{ height:12px; border-radius:7px; }
    .hTrack.jet .hFill{ top:1px; bottom:1px; border-radius:6px; }

    .histWrap{ max-height:160px; }
  }

  @media (max-width: 420px){
    header{ padding:8px; }
    .charthead{ padding:6px 8px; font-size:11px; }
    .anglebadge{ font-size:10px; padding:2px 6px; }
    #signals-title{ font-size:12px; }
    .sig-card{ padding:6px 7px; }
    .toast-card{ min-width:220px; max-width:92vw; }
  }

  /* Popups */
  .tp-modal-backdrop,
  .signal-modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.85);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9998;
  }
  .tp-modal-backdrop.show,
  .signal-modal-backdrop.show{
    display:flex;
  }
  .tp-modal,
  .signal-modal{
    background:#020617;
    border:1px solid #1f2937;
    border-radius:16px;
    padding:16px 18px;
    width:320px;
    max-width:90vw;
    box-shadow:0 20px 50px rgba(0,0,0,0.8);
  }
  .tp-title,
  .signal-title{
    font-size:14px;
    font-weight:600;
    margin-bottom:10px;
    color:#e5e7eb;
  }
  .tp-field,
  .signal-field{
    margin-bottom:10px;
    font-size:12px;
  }
  .tp-field label,
  .signal-field label{
    display:block;
    margin-bottom:4px;
    color:#9ca3af;
  }
  .alarm-inline,
  .signal-inline{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .alarm-note{
    font-size:11px;
    color:#6b7280;
    margin-top:3px;
  }
  .tp-actions,
  .signal-actions{
    display:flex;
    justify-content:flex-end;
    gap:8px;
    margin-top:12px;
  }
  .btn-secondary{
    background:#020617;
    border-color:#374151;
    color:#d1d5db;
  }
  .btn-primary{
    background:#22c55e;
    border-color:#16a34a;
    color:#052e16;
    font-weight:600;
  }
  .btn-primary:hover{ background:#16a34a; }

  /* BPG_UI_THEME_START */
  :root{--bpg-white:#000000;--bpg-yellow:#facc15;--bpg-red:#dc2626;--bpg-green:#16a34a;--bpg-ink:#14532d;}
  body{ background:var(--bpg-white)!important; color:#ffffff!important; }
  header{ background:var(--bpg-white)!important;border-bottom:2px solid var(--bpg-red)!important;}
  header h1{color:var(--bpg-ink)!important;}
  select,button{background:var(--bpg-white)!important;color:var(--bpg-ink)!important;border:2px solid var(--bpg-red)!important;}
  #status{ background:#0b0b0b!important;color:var(--bpg-ink)!important;border:2px solid var(--bpg-red)!important;}
  .chartbox{ background:#0b0b0b!important;border:2px solid var(--bpg-red)!important;}
  .charthead{background:var(--bpg-yellow)!important;color:#000!important;border-bottom:2px solid var(--bpg-red)!important;}
  .anglebadge{background:var(--bpg-white)!important;border:2px solid var(--bpg-red)!important;color:var(--bpg-ink)!important;}
  #signals{background:var(--bpg-white)!important;border-left:2px solid var(--bpg-red)!important;}
  .sig-card{ background:#0b0b0b!important;border:2px solid var(--bpg-red)!important;color:var(--bpg-ink)!important;}
  .symbol{ background:#0b0b0b!important;border:2px solid var(--bpg-red)!important;color:var(--bpg-ink)!important;}
  .buy{color:var(--bpg-green)!important;}
  .sell{color:var(--bpg-red)!important;}
  .close{color:var(--bpg-yellow)!important;}
  #emaAnglePanel{border:3px solid var(--bpg-red)!important;background:var(--bpg-white)!important;}
  .bpg-panel-title{display:flex;align-items:center;gap:8px;font-weight:900;font-size:12px;margin-bottom:6px;color:var(--bpg-ink)!important;}
  .bpg-icon-turbo,.bpg-icon-cutoff{display:inline-flex;align-items:center;justify-content:center;color:var(--bpg-red)!important;}
  .bpg-cutoff{display:inline-flex;align-items:center;gap:6px;font-weight:800;}
  #emaAngleSlider{accent-color:var(--bpg-red);}
  /* BPG_UI_THEME_END */


  /* =========================================================
     ONE-SCREEN FIT (Charts small + same screen)
     ========================================================= */
  body{ overflow:hidden !important; }
  #layout{ overflow:hidden !important; }

  /* Give top area more space, indicators less space */
  #top-row{
    flex: 1 1 auto !important;
    min-height: 0 !important;
  }

  /* Make bottom indicators smaller so charts can fit */
  #bottom-indicators{
    flex: 0 0 26% !important;
    min-height: 0 !important;
    max-height: 30dvh !important;
    padding: 6px !important;

    /* ✅ FIX: allow scrolling to see all indicators */
    overflow-y: auto !important;
    overflow-x: hidden !important;
    -webkit-overflow-scrolling: touch;
  }

  /* indicators tighter */
  #bottom-indicators .bi-row{ gap:6px !important; }
  #bottom-indicators .bi-card{ padding:6px !important; border-radius:10px !important; }
  #bottom-indicators .bi-title{ font-size:10px !important; }
  #bottom-indicators .bi-sub{ font-size:9px !important; }
  #bottom-indicators .chartind{ max-height:52px !important; }
  .histWrap{ max-height:110px !important; }

  /* Signals: tighter + internal scroll only */
  #signals{
    width: 260px !important;
    max-width: 34vw !important;
    padding: 6px !important;
    overflow: hidden !important;
    display:flex !important;
    flex-direction:column !important;
  }
  #sig-list{
    overflow:auto !important;
    min-height:0 !important;
    -webkit-overflow-scrolling:touch;
  }

  /* Chart area: NO scroll. Fit to remaining height */
  #chart-wrap{
    flex: 1 1 auto !important;
    min-width: 0 !important;
    height: 100% !important;
    overflow: hidden !important;
  }

  /* Charts in a grid that fits one screen */
  #chart-grid{
    height: 100% !important;
    min-height: 0 !important;
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    grid-template-rows: repeat(3, minmax(0, 1fr)) !important;
    gap: 6px !important;
    padding: 6px !important;
    box-sizing: border-box !important;
  }
  #chart-row-top, #chart-row-bottom{ display:none !important; }

  #chart-grid .chartbox{
    height: auto !important;
    min-height: 0 !important;
  }

  .charthead{
    padding: 3px 6px !important;
    font-size: 10px !important;
  }
  .anglebadge{
    font-size: 9px !important;
    padding: 1px 6px !important;
  }

  .chartsplit{ flex:1; min-height:0 !important; }
  .chartcanvas{ flex:1; min-height:0 !important; }

  /* Place 5 charts in 2x3 grid, last chart spans full width */
  #chart-grid .chartbox:nth-child(1){ grid-column:1; grid-row:1; }
  #chart-grid .chartbox:nth-child(2){ grid-column:2; grid-row:1; }
  #chart-grid .chartbox:nth-child(3){ grid-column:1; grid-row:2; }
  #chart-grid .chartbox:nth-child(4){ grid-column:2; grid-row:2; }
  #chart-grid .chartbox:nth-child(5){ grid-column:1 / span 2; grid-row:3; }

  @media (max-width: 700px){
    #top-row{ flex-direction:column !important; }

    #chart-wrap{ height: 58dvh !important; }

    #signals{
      height: 18dvh !important;
      width: 100% !important;
      max-width:100% !important;
      border-left:none !important;
      border-top:2px solid #1e293b !important;
    }
    #bottom-indicators{
      flex: 0 0 24% !important;
      max-height: 24dvh !important;
    }

    #chart-grid{
      gap: 5px !important;
      padding: 5px !important;
    }
  }
</style>
</head>

<body>
<header>
  <h1>B Plus Gaing Momentum Break Core</h1>

  <button id="openTp" class="btn-tp">Add TP option</button>
  <button id="openSignalSettings" class="btn-signal-settings">Signals settings</button>

  <label style="font-size:12px;color:#9ca3af;">Market</label>
  <select id="symbol">
      <optgroup label="Binance Spot" id="binanceGroup"></optgroup>
      <optgroup label="Binance Futures (USD-M Perp)" id="binanceFuturesGroup"></optgroup>
      <optgroup label="Deriv (Manual)" id="derivGroup"></optgroup>
  </select>

  <!-- ✅ TF renamed to Interval -->
  <label style="font-size:12px;color:#9ca3af;">Main Interval</label>
  <select id="tf">
    <option value="1m">1m</option>
    <option value="5m">5m</option>
    <option value="10m">10m</option>
    <option value="15m">15m</option>
    <option value="30m">30m</option>
    <option value="1h" selected>1h</option>
    <option value="2h">2h</option>
    <option value="4h">4h</option>
    <option value="1d">1D</option>
  </select>

  <label style="font-size:12px;color:#9ca3af;">Interval 2</label>
  <select id="tf2">
    <option value="1m">1m</option>
    <option value="5m">5m</option>
    <option value="10m">10m</option>
    <option value="15m">15m</option>
    <option value="30m">30m</option>
    <option value="1h">1h</option>
    <option value="2h" selected>2h</option>
    <option value="4h">4h</option>
    <option value="1d">1D</option>
  </select>

  <label style="font-size:12px;color:#9ca3af;">Interval 3</label>
  <select id="tf3">
    <option value="1m">1m</option>
    <option value="5m">5m</option>
    <option value="10m">10m</option>
    <option value="15m">15m</option>
    <option value="30m">30m</option>
    <option value="1h">1h</option>
    <option value="2h">2h</option>
    <option value="4h">4h</option>
    <option value="1d" selected>1D</option>
  </select>

  <label style="font-size:12px;color:#9ca3af;">Interval 4</label>
  <select id="tf4">
    <option value="1m">1m</option>
    <option value="5m">5m</option>
    <option value="10m">10m</option>
    <option value="15m">15m</option>
    <option value="30m">30m</option>
    <option value="1h">1h</option>
    <option value="2h">2h</option>
    <option value="4h" selected>4h</option>
    <option value="1d">1D</option>
  </select>

  <label style="font-size:12px;color:#9ca3af;">Interval 5</label>
  <select id="tf5">
    <option value="1m">1m</option>
    <option value="5m">5m</option>
    <option value="10m">10m</option>
    <option value="15m" selected>15m</option>
    <option value="30m">30m</option>
    <option value="1h">1h</option>
    <option value="2h">2h</option>
    <option value="4h">4h</option>
    <option value="1d">1D</option>
  </select>

  <button id="load">Load</button>
  <span id="status">Initializing…</span>
</header>

<div id="layout">
  <div id="top-row">
    <div id="chart-wrap">
      <div id="chart-grid">
        <div class="chartbox">
          <div class="charthead">
            <div>Main (<span id="tfLabel1"></span>)</div>
            <div class="anglewrap"><span id="angle1" class="anglebadge">—</span></div>
          </div>
          <div class="chartsplit"><div class="chartcanvas" id="chart"></div></div>
        </div>

        <div class="chartbox">
          <div class="charthead">
            <div>Interval 2 (<span id="tfLabel2"></span>)</div>
            <div class="anglewrap"><span id="angle2" class="anglebadge">—</span></div>
          </div>
          <div class="chartsplit"><div class="chartcanvas" id="chart2"></div></div>
        </div>

        <div class="chartbox">
          <div class="charthead">
            <div>Interval 3 (<span id="tfLabel3"></span>)</div>
            <div class="anglewrap"><span id="angle3" class="anglebadge">—</span></div>
          </div>
          <div class="chartsplit"><div class="chartcanvas" id="chart3"></div></div>
        </div>

        <div class="chartbox">
          <div class="charthead">
            <div>Interval 4 (<span id="tfLabel4"></span>)</div>
            <div class="anglewrap"><span id="angle4" class="anglebadge">—</span></div>
          </div>
          <div class="chartsplit"><div class="chartcanvas" id="chart4"></div></div>
        </div>

        <div class="chartbox">
          <div class="charthead">
            <div>Interval 5 (<span id="tfLabel5"></span>)</div>
            <div class="anglewrap"><span id="angle5" class="anglebadge">—</span></div>
          </div>
          <div class="chartsplit"><div class="chartcanvas" id="chart5"></div></div>
        </div>
      </div>

      <!-- legacy (not used) -->
      <div id="chart-row-top" style="display:none"></div>
      <div id="chart-row-bottom" style="display:none"></div>
    </div>

    <div id="signals">
      <div id="emaAnglePanel" class="sig-card" style="margin-bottom:10px;">
        <div class="bpg-panel-title" data-bpg="turbo-scan-gate">
          <span class="bpg-icon-turbo" aria-hidden="true">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2l2.2 6.3H21l-5.4 3.9L17.8 18 12 14.1 6.2 18l2.2-5.8L3 8.3h6.8L12 2z" stroke="currentColor" stroke-width="2" fill="currentColor"/>
            </svg>
          </span>
          <span>B Plus Gaing Turbo Scan Gate</span>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <span class="bpg-cutoff" data-bpg="cutoff">
            <span class="bpg-icon-cutoff" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M7 18V8l5-3 5 3v10" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                <path d="M12 12v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <circle cx="12" cy="12" r="2" fill="currentColor"/>
              </svg>
            </span>
            <span>Cutoff</span>
          </span>
          <span id="emaAngleVal" style="font-size:11px;color:#e5e7eb;">5°</span>
        </div>

        <input id="emaAngleSlider" type="range" min="1" max="80" value="5" step="1" style="width:100%;margin-top:6px;">
        <div style="font-size:11px;color:#6b7280;margin-top:6px;line-height:1.25;">
          DOWN if angle ≤ -<span id="emaAngleVal2">5</span>° &nbsp;|&nbsp;
          UP if angle ≥ <span id="emaAngleVal3">5</span>°
        </div>

        <div style="margin-top:6px;font-size:12px;">
          <span style="color:#9ca3af;">B Plus Gaing Turbo Scan Result:</span>
          <span id="emaAllTrendLabel" style="font-weight:800;">—</span>
        </div>
      </div>

      <div id="aiPlanPanel" class="sig-card" style="margin-bottom:10px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <div style="font-size:12px;color:#e5e7eb;font-weight:600;">OpenAI Trade Plan</div>
          <div id="aiPlanStatus" style="font-size:11px;color:#9ca3af;">—</div>
        </div>
        <div style="margin-top:8px;display:grid;grid-template-columns: 1fr 1fr;gap:8px;">
          <div><div style="font-size:11px;color:#94a3b8;">Bias</div><div id="aiBias" style="font-size:14px;font-weight:800;">WAIT</div></div>
          <div><div style="font-size:11px;color:#94a3b8;">Confidence</div><div id="aiConf" style="font-size:14px;font-weight:800;">0%</div></div>
        </div>
        <div style="margin-top:8px;"><div style="font-size:11px;color:#94a3b8;">Entry</div><div id="aiEntry" style="font-size:13px;font-weight:700;">—</div></div>
        <div style="margin-top:6px;display:grid;grid-template-columns: 1fr 1fr;gap:8px;">
          <div><div style="font-size:11px;color:#94a3b8;">SL</div><div id="aiSL" style="font-size:13px;font-weight:700;">—</div></div>
          <div><div style="font-size:11px;color:#94a3b8;">TPs</div><div id="aiTP" style="font-size:13px;font-weight:700;">—</div></div>
        </div>
        <div style="margin-top:8px;"><div style="font-size:11px;color:#94a3b8;">Reasons</div><div id="aiReason" style="font-size:11px;color:#cbd5e1;line-height:1.35;">—</div></div>
        <div style="margin-top:6px;"><div style="font-size:11px;color:#94a3b8;">Invalidation</div><div id="aiInvalid" style="font-size:11px;color:#cbd5e1;line-height:1.35;">—</div></div>
      </div>

      <div id="aiComparePanel" class="sig-card" style="margin-bottom:10px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <div style="font-size:12px;color:#e5e7eb;font-weight:600;">B Plus Gaing Insight vs Core</div>
          <div id="cmpStatus" style="font-size:11px;color:#9ca3af;">—</div>
        </div>
        <div style="margin-top:8px;display:grid;grid-template-columns: 1fr 1fr;gap:8px;">
          <div>
            <div style="font-size:11px;color:#94a3b8;">Core</div>
            <div id="cmpEngine" style="font-size:14px;font-weight:800;">—</div>
            <div id="cmpEngineMeta" style="font-size:11px;color:#9ca3af;margin-top:2px;">—</div>
          </div>
          <div>
            <div style="font-size:11px;color:#94a3b8;">OpenAI</div>
            <div id="cmpAI" style="font-size:14px;font-weight:800;">—</div>
            <div id="cmpAIMeta" style="font-size:11px;color:#9ca3af;margin-top:2px;">—</div>
          </div>
        </div>
        <div style="margin-top:8px;">
          <div style="font-size:11px;color:#94a3b8;">Decision</div>
          <div id="cmpDecision" style="font-size:12px;color:#cbd5e1;line-height:1.35;">—</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:10px;">
        <div id="signals-title">Live Signals – Selected Market (last 15 minutes)</div>
        <select id="sigTfFilter" style="background:#0b1220;border:1px solid #1f2937;color:#e5e7eb;border-radius:10px;padding:6px 10px;font-size:12px;">
          <!-- ✅ TF renamed -->
          <option value="all" selected>All Intervals</option>
          <option value="1m">1m</option>
          <option value="2m">2m</option>
          <option value="5m">5m</option>
          <option value="10m">10m</option>
          <option value="15m">15m</option>
          <option value="30m">30m</option>
          <option value="1h">1h</option>
        </select>
      </div>
      <div id="sig-list" style="font-size:12px;color:#9ca3af;">Waiting for data…</div>
    </div>
  </div>

  <div id="bottom-indicators">
    <div class="bi-row">
      <div class="bi-card">
        <div class="bi-title">Trend Strength — 1h</div>
        <div class="bi-sub">Up trend = green candles • Down trend = red candles</div>
        <div class="bi-slot"><div class="chartind" id="ind1"></div></div>
      </div>

      <div class="bi-card">
        <div class="bi-title">Trend Strength — 2h</div>
        <div class="bi-sub">Up trend = green candles • Down trend = red candles</div>
        <div class="bi-slot"><div class="chartind" id="ind2"></div></div>
      </div>

      <div class="bi-card">
        <div class="bi-title">Trend Strength — 4h</div>
        <div class="bi-sub">Up trend = green candles • Down trend = red candles</div>
        <div class="bi-slot"><div class="chartind" id="ind3"></div></div>
      </div>

      <div class="bi-card">
        <div class="bi-title">Trend Strength — 1d</div>
        <div class="bi-sub">Up trend = green candles • Down trend = red candles</div>
        <div class="bi-slot"><div class="chartind" id="ind4"></div></div>
      </div>

      <div class="bi-card jetCard">
        <div class="bi-title">B Plus Gaing Identify Strength — 15m</div>
        <div class="bi-sub">Stronger = darker • Weaker = lighter • BUY green / SELL red</div>
        <div class="bi-slot"><div class="chartind" id="ind5"></div></div>
      </div>

      <div class="bi-card" id="indHistoryCard">
        <div class="bi-title">B Plus Gaing Signals History (latest)</div>
        <div class="bi-sub">Signals that arrived live (auto-updates)</div>
        <div class="histWrap" id="indHistory">Waiting…</div>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- TP Settings -->
<div id="tpModal" class="tp-modal-backdrop">
  <div class="tp-modal">
    <div class="tp-title">TP Settings</div>

    <div class="tp-field">
      <label>TP places</label>
      <select id="tpCount">
        <option value="1">1 TP</option>
        <option value="2">2 TP</option>
        <option value="3">3 TP</option>
        <option value="4">4 TP</option>
        <option value="5">5 TP</option>
      </select>
      <div class="alarm-note">Keep 1 to 5 TP places for each signal.</div>
    </div>

    <div class="tp-field">
      <label>TP background color</label>
      <input type="color" id="tpBgColor" value="#1d4ed8">
    </div>

    <div class="tp-field">
      <label>TP font color</label>
      <input type="color" id="tpFontColor" value="#000000">
    </div>

    <div class="tp-field">
      <label>TP sound</label>
      <div class="alarm-inline">
        <select id="tpSoundEnabled">
          <option value="on" selected>ON</option>
          <option value="off">OFF</option>
        </select>
      </div>
      <div class="alarm-note">Turn TP achieve sound on or off.</div>
    </div>

    <div class="tp-field">
      <label>TP achieve sound</label>
      <div class="alarm-inline">
        <select id="tpSoundType">
          <option value="slot">Slot machine payout</option>
          <option value="emergency">Emergency alert</option>
          <option value="hall">Hall alert</option>
          <option value="facility">Facility alarm</option>
          <option value="classic">Classic alarm</option>
        </select>
        <button id="testTpSound" class="btn-secondary" style="font-size:11px;padding:4px 8px;">Test TP sound</button>
      </div>
      <div class="alarm-note">Sound used when TP1–TP5 are achieved.</div>
    </div>

    <div class="tp-actions">
      <button id="closeTp" class="btn-secondary">Close</button>
      <button id="saveTp" class="btn-primary">Save</button>
    </div>
  </div>
</div>

<!-- Signals Settings -->
<div id="signalModal" class="signal-modal-backdrop">
  <div class="signal-modal">
    <div class="signal-title">Signals Settings</div>

    <div class="signal-field">
      <label>Graph Interval (for notifications)</label>
      <select id="signalTfFilter">
        <option value="1m">1 minute</option>
        <option value="2m">2 minutes</option>
        <option value="5m">5 minutes</option>
        <option value="10m">10 minutes</option>
        <option value="15m">15 minutes</option>
        <option value="30m">30 minutes</option>
        <option value="1h">1 hour</option>
        <option value="4h">4 hours</option>
      </select>
      <div class="alarm-note">If saved, notifications & sounds will come only for this interval.</div>
    </div>

    <div class="signal-field">
      <label>Notification display</label>
      <select id="notifPosition">
        <option value="top-left">Top left corner</option>
        <option value="top-right">Top right corner</option>
        <option value="bottom-left">Bottom left corner</option>
        <option value="bottom-right">Bottom right corner</option>
        <option value="center" selected>Center</option>
      </select>
    </div>

    <div class="signal-field">
      <label>Notification holding time (seconds)</label>
      <input type="number" id="notifHold" min="2" max="60" value="4" style="width:80px;">
      <div class="alarm-note">Between 2 – 60 seconds. How long notifications stay visible.</div>
    </div>

    <div class="signal-field">
      <label>Notification background color</label>
      <input type="color" id="notifBgColor" value="#020617">
    </div>

    <div class="signal-field">
      <label>Notification font color</label>
      <input type="color" id="notifFontColor" value="#e5e7eb">
    </div>

    <div class="signal-field">
      <label>Alarm sound</label>
      <div class="alarm-inline">
        <select id="soundType">
          <option value="1">Beep type 1</option>
          <option value="2">Beep type 2</option>
          <option value="3">Beep type 3</option>
          <option value="4">Beep type 4</option>
          <option value="5">Beep type 5</option>
          <option value="slot">Slot machine payout (file)</option>
          <option value="emergency">Emergency alert (file)</option>
          <option value="hall">Hall alert (file)</option>
          <option value="facility">Facility alarm (file)</option>
          <option value="classic">Classic alarm (file)</option>
          <option value="custom">Custom (uploaded)</option>
        </select>
        <button id="testSound" class="btn-secondary" style="font-size:11px;padding:4px 8px;">Test</button>
      </div>
      <div class="alarm-note">Choose a sound type and test before saving.</div>
    </div>

    <div class="signal-field">
      <label>Ringing time</label>
      <select id="soundDuration">
        <option value="3">3 seconds</option>
        <option value="5">5 seconds</option>
        <option value="7">7 seconds</option>
        <option value="10">10 seconds</option>
        <option value="15">15 seconds</option>
      </select>
      <div class="alarm-note">Alarm will ring between 3 – 15 seconds.</div>
    </div>

    <div class="signal-field">
      <label>Add own alarm sound</label>
      <input type="file" id="customSoundFile" accept="audio/*">
      <div class="alarm-note">Upload your own audio and select <strong>Custom (uploaded)</strong> in Alarm sound.</div>
    </div>

    <div class="signal-field" style="margin-top:12px;padding-top:10px;border-top:1px solid #1f2937;">
      <label>EMA overlays (on chart)</label>

      <div class="signal-inline" style="justify-content:space-between;">
        <div style="display:flex;gap:8px;align-items:center;">
          <span style="font-size:12px;color:#9ca3af;">EMA 1</span>
          <select id="ema1Enabled" style="min-width:70px;">
            <option value="on" selected>ON</option>
            <option value="off">OFF</option>
          </select>
          <input type="number" id="ema1Period" min="1" max="200" value="10" style="width:80px;">
        </div>
        <span style="font-size:11px;color:#6b7280;">Period 1–200</span>
      </div>

      <div class="signal-inline" style="justify-content:space-between;margin-top:8px;">
        <div style="display:flex;gap:8px;align-items:center;">
          <span style="font-size:12px;color:#9ca3af;">EMA 2</span>
          <select id="ema2Enabled" style="min-width:70px;">
            <option value="on" selected>ON</option>
            <option value="off">OFF</option>
          </select>
          <input type="number" id="ema2Period" min="1" max="200" value="1" style="width:80px;">
        </div>
        <span style="font-size:11px;color:#6b7280;">Optional 2nd EMA</span>
      </div>

      <div class="alarm-note" style="margin-top:6px;">EMA lines are drawn on the main price chart. Save to apply.</div>
    </div>

    <div class="signal-actions">
      <button id="closeSignal" class="btn-secondary">Close</button>
      <button id="previewSignal" class="btn-secondary">Preview</button>
      <button id="saveSignal" class="btn-primary">Save</button>
    </div>
  </div>
</div>

<script>
/* ============================
   CONFIG + HELPERS
   ============================ */
const APP_ID = 108701;
const API_TOKEN = "QSDAQPsfjphEvtT";
const WS_URL  = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;

/* Deriv manual symbols */
let ALL_SYMBOLS = [
  "R_10","R_25","R_50","R_75","R_100",
  "R_10S","R_25S","R_50S","R_75S","R_100S",
  "frxAUDCAD","frxAUDCHF","frxAUDJPY","frxAUDNZD","frxAUDUSD",
  "frxEURAUD","frxEURCAD","frxEURCHF","frxEURGBP","frxEURJPY","frxEURNOK","frxEURNZD","frxEURUSD",
  "frxGBPAUD","frxGBPCAD","frxGBPCHF","frxGBPJPY","frxGBPNOK","frxGBPUSD",
  "frxNZDJPY","frxNZDUSD",
  "frxUSDCAD","frxUSDCHF","frxUSDJPY","frxUSDNOK","frxUSDPLN","frxUSDSEK","frxUSDZAR"
];

const $ = id => document.getElementById(id);
const statusEl = $("status");
function setStatus(t){ if(statusEl) statusEl.textContent = t; }

function __fmtNum(x){
  const n = Number(x);
  if(!isFinite(n)) return "—";
  if(Math.abs(n) >= 1000) return n.toFixed(2);
  if(Math.abs(n) >= 1) return n.toFixed(4);
  return n.toFixed(6);
}

/* ========== Toast ========== */
function __posToast(pos){
  const t = $("toast");
  if(!t) return;

  t.style.left = "";
  t.style.right = "";
  t.style.top = "";
  t.style.bottom = "";

  t.style.setProperty("--toast-tx","0px");
  t.style.setProperty("--toast-ty","20px");

  const pad = "16px";
  if(pos === "top-left"){ t.style.left=pad; t.style.top=pad; }
  else if(pos === "top-right"){ t.style.right=pad; t.style.top=pad; }
  else if(pos === "bottom-left"){ t.style.left=pad; t.style.bottom=pad; }
  else if(pos === "center"){
    t.style.left="50%";
    t.style.top="50%";
    t.style.setProperty("--toast-tx","-50%");
  }
  else { t.style.right=pad; t.style.bottom=pad; }
}
let __toastTimer=null;
function showToast(content, pos=NOTIF_POSITION, hold=NOTIF_HOLD_SECONDS){
  const t = $("toast");
  if(!t) return;
  __posToast(pos);
  if(typeof content === "string" && content.trim().startsWith("<")){
    t.innerHTML = content;
  }else{
    t.innerHTML = `<div class="toast-card"><div class="toast-title">${String(content||"")}</div></div>`;
  }
  t.classList.add("show");
  if(__toastTimer) clearTimeout(__toastTimer);
  __toastTimer = setTimeout(()=> t.classList.remove("show"), Math.max(2, Number(hold)||4)*1000);
}

/* ========== Sounds ========== */
const SIGNAL_SOUNDS_BASE = "https://derivesupanalyzer.site/wp-content/jet%20bot/Turbo%20Manual/notifications%20sounds/";
const SIGNAL_SOUND_FILES = {
  slot:     "mixkit-casino-win-alarm-and-coins-1990.wav",
  emergency:"mixkit-critical-alarm-1004.wav",
  hall:     "mixkit-clear-announce-tones-2861.wav",
  facility: "mixkit-interface-option-select-2573.wav",
  classic:  "mixkit-happy-bells-notification-937.wav"
};
let alarmAudio = new Audio();

const TP_SOUNDS_BASE = "https://derivesupanalyzer.site/wp-content/jet%20bot/Turbo%20Manual/TP%20sounds/";
const TP_SOUND_FILES = {
  slot:     "mixkit-slot-machine-payout-alarm-1996.wav",
  emergency:"mixkit-emergency-alert-alarm-1007.wav",
  hall:     "mixkit-sound-alert-in-hall-1006.wav",
  facility: "mixkit-facility-alarm-sound-999.wav",
  classic:  "mixkit-classic-alarm-995.wav"
};
let tpAudio = new Audio();

function __playAudio(aud, src, seconds){
  try{
    if(!aud) return;
    aud.pause();
    aud.currentTime = 0;
    aud.src = src;
    aud.play().catch(()=>{});
    if(seconds && isFinite(seconds)){
      setTimeout(()=>{ try{ aud.pause(); }catch(_){ } }, Math.max(1,seconds)*1000);
    }
  }catch(_){}
}

function playBeep(){
  const type = String(SOUND_TYPE||"1");
  const sec = Math.max(3, Math.min(15, Number(SOUND_DURATION)||3));

  if(type === "custom" && customAudio){
    __playAudio(customAudio, customAudio.src, sec);
    return;
  }
  if(SIGNAL_SOUND_FILES[type]){
    __playAudio(alarmAudio, SIGNAL_SOUNDS_BASE + SIGNAL_SOUND_FILES[type], sec);
    return;
  }

  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    const base = { "1":440, "2":520, "3":660, "4":330, "5":880 }[type] || 440;
    o.frequency.value = base;
    g.gain.value = 0.06;
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, sec*1000);
  }catch(_){}
}

function playTpSound(){
  if (TP_SOUND_ENABLED === "off") return;
  const f = TP_SOUND_FILES[TP_SOUND_TYPE] || TP_SOUND_FILES.slot;
  __playAudio(tpAudio, TP_SOUNDS_BASE + f, 4);
}

/* ========== UI settings state ========== */
const soundTypeEl      = $("soundType");
const soundDurationEl  = $("soundDuration");
const testSoundBtn     = $("testSound");
const customSoundInput = $("customSoundFile");
let SOUND_TYPE = soundTypeEl ? soundTypeEl.value : "1";
let SOUND_DURATION = soundDurationEl ? Number(soundDurationEl.value) || 3 : 3;
let customAudio = null;

/* TP SETTINGS */
const openTpBtn         = $("openTp");
const tpModal           = $("tpModal");
const tpCountEl         = $("tpCount");
const tpBgColorEl       = $("tpBgColor");
const tpFontColorEl     = $("tpFontColor");
const tpSoundEnabledEl  = $("tpSoundEnabled");
const tpSoundTypeEl     = $("tpSoundType");
const testTpSoundBtn    = $("testTpSound");
const saveTpBtn         = $("saveTp");
const closeTpBtn        = $("closeTp");

let TP_COUNT      = tpCountEl ? Number(tpCountEl.value) || 1 : 1;
let TP_BG_COLOR   = tpBgColorEl ? tpBgColorEl.value : "#1d4ed8";
let TP_FONT_COLOR = tpFontColorEl ? tpFontColorEl.value : "#000000";
let TP_SOUND_TYPE = tpSoundTypeEl ? tpSoundTypeEl.value : "slot";
let TP_SOUND_ENABLED = "on";

/* SIGNALS SETTINGS */
const openSignalSettingsBtn = $("openSignalSettings");
const signalModal           = $("signalModal");
const signalTfFilterEl      = $("signalTfFilter");
const notifPositionEl       = $("notifPosition");
const notifHoldEl           = $("notifHold");
const notifBgColorEl        = $("notifBgColor");
const notifFontColorEl      = $("notifFontColor");
const saveSignalBtn         = $("saveSignal");
const closeSignalBtn        = $("closeSignal");
const previewSignalBtn      = $("previewSignal");

let SIGNAL_FILTER_TF   = null;
let NOTIF_POSITION     = "center";
let NOTIF_HOLD_SECONDS = 4;
let NOTIF_BG_COLOR     = "#020617";
let NOTIF_FONT_COLOR   = "#e5e7eb";

/* EMA SETTINGS */
const ema1EnabledEl = $("ema1Enabled");
const ema1PeriodEl  = $("ema1Period");
const ema2EnabledEl = $("ema2Enabled");
const ema2PeriodEl  = $("ema2Period");
let EMA1_ENABLED = "on";
let EMA2_ENABLED = "on";
let EMA1_PERIOD  = 10;
let EMA2_PERIOD  = 1;

/* GLOBAL SIGNAL LOG */
let GLOBAL_SIGNALS = [];
let GLOBAL_SIGNAL_KEYS = new Set();
function ensureGlobalSignal(s){
  try{
    if(!s) return;
    const nowSec = Math.floor(Date.now()/1000);
    if(typeof s.time === "number" && s.time > 20000000000) s.time = Math.floor(s.time/1000);
    if(typeof s.time === "number" && (nowSec - s.time) > 3600) return;
    const key = (s.symbol||"") + "|" + (s.tf||"") + "|" + String(s.time||"") + "|" + (s.dir||"");
    if(GLOBAL_SIGNAL_KEYS.has(key)) return;
    GLOBAL_SIGNAL_KEYS.add(key);
    GLOBAL_SIGNALS.push(s);
    GLOBAL_SIGNALS = GLOBAL_SIGNALS.filter(x => (nowSec - (Number(x.time)||nowSec)) <= 6*3600);
  }catch(_){}
}

/* render history under indicators */
function renderIndicatorHistory(){
  const el = $("indHistory");
  if(!el) return;
  const nowSec = Math.floor(Date.now()/1000);
  const list = (GLOBAL_SIGNALS||[])
    .filter(s => (nowSec - (Number(s.time)||nowSec)) <= 6*3600)
    .slice()
    .sort((a,b)=> (b.time||0)-(a.time||0))
    .slice(0, 60);

  if(!list.length){
    el.innerHTML = `<div style="color:#94a3b8;font-size:12px;padding:6px 2px;">No signal history yet.</div>`;
    return;
  }

  el.innerHTML = list.map(s=>{
    const ts = new Date((Number(s.time)||0)*1000).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    const dir = String(s.dir||"").toLowerCase();
    const cls = (dir==="buy") ? "histDirBuy" : (dir==="sell") ? "histDirSell" : "histDirClose";
    const dTxt = (dir||"").toUpperCase();
    return `
      <div class="histItem">
        <div class="histTop">
          <span class="histSym">${String(s.symbol||"")}</span>
          <span class="${cls}">${dTxt}</span>
          <span style="color:#64748b;font-size:11px;">•</span>
          <span style="color:#cbd5e1;font-size:11px;font-weight:800;">${String(s.tf||"")}</span>
          <span style="margin-left:auto;color:#94a3b8;font-size:11px;">${ts}</span>
        </div>
        <div class="histMeta">
          Entry: <span style="color:#e5e7eb;font-weight:800;">${__fmtNum(s.price)}</span>
          ${s.tp!=null ? ` &nbsp;|&nbsp; TP: <span style="color:#e5e7eb;font-weight:800;">${__fmtNum(s.tp)}</span>` : ``}
          <div style="margin-top:4px;color:#9ca3af;">${String(s.label||"")}</div>
        </div>
      </div>
    `;
  }).join("");
}

/* ============================
   POPUPS wiring
   ============================ */
if (openTpBtn && tpModal) {
  openTpBtn.onclick = () => {
    tpCountEl.value      = String(TP_COUNT);
    tpBgColorEl.value    = TP_BG_COLOR;
    tpFontColorEl.value  = TP_FONT_COLOR;
    tpSoundTypeEl.value  = TP_SOUND_TYPE;
    if (tpSoundEnabledEl) tpSoundEnabledEl.value = TP_SOUND_ENABLED;
    tpModal.classList.add("show");
  };
}
if (closeTpBtn && tpModal) closeTpBtn.onclick = () => tpModal.classList.remove("show");
if (saveTpBtn && tpModal) {
  saveTpBtn.onclick = () => {
    TP_COUNT       = Math.max(1, Math.min(5, Number(tpCountEl.value) || 1));
    TP_BG_COLOR    = tpBgColorEl.value || "#1d4ed8";
    TP_FONT_COLOR  = tpFontColorEl.value || "#000000";
    TP_SOUND_TYPE  = tpSoundTypeEl.value || "slot";
    TP_SOUND_ENABLED = (tpSoundEnabledEl && tpSoundEnabledEl.value) || "on";
    renderSignals();
    renderIndicatorHistory();
    tpModal.classList.remove("show");
    showToast("TP settings saved");
  };
}
if (testTpSoundBtn && tpSoundTypeEl) {
  testTpSoundBtn.onclick = () => {
    if (tpSoundEnabledEl && tpSoundEnabledEl.value === "off") { showToast("TP sound is OFF"); return; }
    const prev = TP_SOUND_TYPE;
    TP_SOUND_TYPE = tpSoundTypeEl.value || "slot";
    playTpSound();
    TP_SOUND_TYPE = prev;
  };
}

if (openSignalSettingsBtn && signalModal) {
  openSignalSettingsBtn.onclick = () => {
    if (!SIGNAL_FILTER_TF) SIGNAL_FILTER_TF = $("tf").value || "5m";
    signalTfFilterEl.value = SIGNAL_FILTER_TF;
    notifPositionEl.value  = NOTIF_POSITION;
    notifHoldEl.value      = String(NOTIF_HOLD_SECONDS);
    if (notifBgColorEl)   notifBgColorEl.value   = NOTIF_BG_COLOR;
    if (notifFontColorEl) notifFontColorEl.value = NOTIF_FONT_COLOR;
    if (soundTypeEl)      soundTypeEl.value      = SOUND_TYPE;
    if (soundDurationEl)  soundDurationEl.value  = String(SOUND_DURATION);
    if (ema1EnabledEl) ema1EnabledEl.value = EMA1_ENABLED;
    if (ema1PeriodEl)  ema1PeriodEl.value  = String(EMA1_PERIOD);
    if (ema2EnabledEl) ema2EnabledEl.value = EMA2_ENABLED;
    if (ema2PeriodEl)  ema2PeriodEl.value  = String(EMA2_PERIOD);
    signalModal.classList.add("show");
  };
}
if (closeSignalBtn && signalModal) closeSignalBtn.onclick = () => signalModal.classList.remove("show");

if (saveSignalBtn && signalModal) {
  saveSignalBtn.onclick = () => {
    SIGNAL_FILTER_TF = signalTfFilterEl.value || $("tf").value || "5m";
    NOTIF_POSITION   = notifPositionEl.value || "center";
    let holdVal = Number(notifHoldEl.value) || 4;
    holdVal = Math.max(2, Math.min(60, holdVal));
    NOTIF_HOLD_SECONDS = holdVal;
    notifHoldEl.value  = String(holdVal);
    if (notifBgColorEl)   NOTIF_BG_COLOR   = notifBgColorEl.value || "#020617";
    if (notifFontColorEl) NOTIF_FONT_COLOR = notifFontColorEl.value || "#e5e7eb";
    if (soundTypeEl) SOUND_TYPE = soundTypeEl.value || "1";
    if (soundDurationEl) {
      let v = Number(soundDurationEl.value) || 3;
      v = Math.max(3, Math.min(15, v));
      SOUND_DURATION = v;
      soundDurationEl.value = String(v);
    }

    if (ema1EnabledEl) EMA1_ENABLED = ema1EnabledEl.value || "on";
    if (ema2EnabledEl) EMA2_ENABLED = ema2EnabledEl.value || "off";

    let p1 = ema1PeriodEl ? Number(ema1PeriodEl.value) : EMA1_PERIOD;
    let p2 = ema2PeriodEl ? Number(ema2PeriodEl.value) : EMA2_PERIOD;
    p1 = Math.max(1, Math.min(200, (isFinite(p1) ? p1 : 10)));
    p2 = Math.max(1, Math.min(200, (isFinite(p2) ? p2 : 20)));
    EMA1_PERIOD = p1;
    EMA2_PERIOD = p2;

    signalModal.classList.remove("show");
    showToast("Signal settings saved");
    calcEMAs();
    recomputeAllSignals();
  };
}

if (previewSignalBtn && signalModal) {
  previewSignalBtn.onclick = () => {
    const tempPos  = notifPositionEl.value || "center";
    let tempHold   = Number(notifHoldEl.value) || 4;
    tempHold       = Math.max(2, Math.min(60, tempHold));
    const bg   = notifBgColorEl ? (notifBgColorEl.value || NOTIF_BG_COLOR) : NOTIF_BG_COLOR;
    const font = notifFontColorEl ? (notifFontColorEl.value || NOTIF_FONT_COLOR) : NOTIF_FONT_COLOR;

    const nowSec = Math.floor(Date.now() / 1000);
    const previewSignal = {
      time:  nowSec,
      dir:   "buy",
      price: 2332.0140,
      tp:    2340.0000,
      label: "B Plus Gaing Momentum break BUY (preview)",
      symbol:"R_25",
      tf:    signalTfFilterEl.value || "5m",
      durationMin: 15,
      srStrength: "Medium"
    };
    const html = buildSignalToastHtml(previewSignal, bg, font);
    showToast(html, tempPos, tempHold);
  };
}

if (customSoundInput) {
  customSoundInput.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    try {
      if (!customAudio) customAudio = new Audio();
      const url = URL.createObjectURL(file);
      customAudio.src = url;
      customAudio.load();
      showToast("Custom alarm sound loaded");
    } catch (err) {
      showToast("Failed to load custom sound");
    }
  });
}
if (testSoundBtn) {
  testSoundBtn.onclick = () => {
    if (soundTypeEl) SOUND_TYPE = soundTypeEl.value || "1";
    if (soundDurationEl) {
      const v = Number(soundDurationEl.value) || 3;
      SOUND_DURATION = Math.max(3, Math.min(15, v));
    }
    playBeep();
  };
}

/* ============================
   Header mobile height fit
   ============================ */
function __setHeaderHeight(){
  try{
    const h = document.querySelector("header");
    if(!h) return;
    const px = Math.max(56, h.offsetHeight || 56);
    document.documentElement.style.setProperty("--header-h", px + "px");
  }catch(_){}
}
window.addEventListener("resize", __setHeaderHeight, { passive:true });
window.addEventListener("orientationchange", __setHeaderHeight, { passive:true });
window.addEventListener("load", ()=>{ setTimeout(__setHeaderHeight, 0); }, { passive:true });
setTimeout(__setHeaderHeight, 250);

/* ============================
   Charts init
   ============================ */
const chart = LightweightCharts.createChart($("chart"), {
  layout:{ background:{type:"solid",color:"#020617"},textColor:"#e5e7eb" },
  grid:{ vertLines:{color:"#020617"}, horzLines:{color:"#020617"} },
  rightPriceScale:{ borderColor:"#1e293b"},
  timeScale:{ borderColor:"#1e293b", timeVisible:true, secondsVisible:true }
});
const candleSeries = chart.addCandlestickSeries({
  upColor:"#16a34a",downColor:"#ef4444",
  wickUpColor:"#16a34a",wickDownColor:"#ef4444",
  borderVisible:false
});
const bbMid   = chart.addLineSeries({ color:"#64748b" });
const bbUpper = chart.addLineSeries({ color:"#f97316" });
const bbLower = chart.addLineSeries({ color:"#22c55e" });
const ema1Series = chart.addLineSeries({ color:"#000000", lineWidth:2 });
const ema2Series = chart.addLineSeries({ color:"#a78bfa", lineWidth:2 });

function makeFullChart(containerId){
  const c = LightweightCharts.createChart($(containerId), {
    layout:{ background:{type:"solid",color:"#020617"},textColor:"#e5e7eb" },
    grid:{ vertLines:{color:"#020617"}, horzLines:{color:"#020617"} },
    rightPriceScale:{ borderColor:"#1e293b"},
    timeScale:{ borderColor:"#1e293b", timeVisible:true, secondsVisible:true }
  });
  const candle = c.addCandlestickSeries({
    upColor:"#16a34a",downColor:"#ef4444",
    wickUpColor:"#16a34a",wickDownColor:"#ef4444",
    borderVisible:false
  });
  const bbMid   = c.addLineSeries({ color:"#64748b" });
  const bbUpper = c.addLineSeries({ color:"#f97316" });
  const bbLower = c.addLineSeries({ color:"#22c55e" });
  const ema1 = c.addLineSeries({ color:"#000000", lineWidth:2 });
  const ema2 = c.addLineSeries({ color:"#a78bfa", lineWidth:2 });

  new ResizeObserver(()=>{ const el = $(containerId); if(!el) return; c.applyOptions({ width: el.clientWidth, height: el.clientHeight }); }).observe($(containerId));
  return { chart:c, series:candle, bbMid, bbUpper, bbLower, ema1, ema2, data:[], angleEl:null, binWs:null };
}
const chart2Bundle = makeFullChart("chart2");
const chart3Bundle = makeFullChart("chart3");
const chart4Bundle = makeFullChart("chart4");
const chart5Bundle = makeFullChart("chart5");

const angle1El = $("angle1");
chart2Bundle.angleEl = $("angle2");
chart3Bundle.angleEl = $("angle3");
chart4Bundle.angleEl = $("angle4");
chart5Bundle.angleEl = $("angle5");

function resizeMainChartToCell(){
  const el = $("chart");
  if (!el) return;
  chart.applyOptions({ width: el.clientWidth, height: el.clientHeight });
}
new ResizeObserver(resizeMainChartToCell).observe($("chart"));
setTimeout(resizeMainChartToCell, 0);

function clearBundle(b){
  if(!b) return;
  try{ b.series.setData([]); }catch(_){}
  try{ b.series.setMarkers([]); }catch(_){}
  try{ b.bbMid.setData([]); }catch(_){}
  try{ b.bbUpper.setData([]); }catch(_){}
  try{ b.bbLower.setData([]); }catch(_){}
  try{ b.ema1.setData([]); }catch(_){}
  try{ b.ema2.setData([]); }catch(_){}
  b.data = [];
}

/* ============================
   Indicators: BB + EMA + Angles + Trend strength
   ============================ */
let DATA = [];
let SIGNALS = [];

function calcEMAValues(arr, period){
  if(!arr || !arr.length) return [];
  period = Math.max(1, Math.min(200, Number(period) || 10));
  const k = 2 / (period + 1);
  let sum = 0;
  let ema = null;
  const out = new Array(arr.length).fill(null);

  for (let i = 0; i < arr.length; i++){
    const close = (arr[i] && typeof arr[i].close === "number") ? arr[i].close : null;
    if (close === null) continue;

    if (i < period){
      sum += close;
      if (i === period - 1){
        ema = sum / period;
        out[i] = ema;
      }
      continue;
    }
    if (ema === null){
      ema = close;
      out[i] = ema;
      continue;
    }
    ema = (close - ema) * k + ema;
    out[i] = ema;
  }
  return out;
}

function calcBBForArray(arr){
  const p=20,d=2;
  if(!arr || arr.length<p) return;
  for(let i=0;i<arr.length;i++){
    if(i<p){
      arr[i].bbMid = arr[i].bbUpper = arr[i].bbLower = null;
      continue;
    }
    let sum=0;
    for(let j=i-p+1;j<=i;j++) sum += arr[j].close;
    let mean = sum/p;
    let v=0;
    for(let j=i-p+1;j<=i;j++){
      let diff = arr[j].close-mean;
      v += diff*diff;
    }
    let sd = Math.sqrt(v/p);
    arr[i].bbMid   = mean;
    arr[i].bbUpper = mean + d*sd;
    arr[i].bbLower = mean - d*sd;
  }
}

function setBBSeriesFromArray(arr, bundleOrNull){
  if(bundleOrNull){
    bundleOrNull.bbMid.setData(arr.filter(c=>c.bbMid!=null).map(c=>({time:c.time,value:c.bbMid})));
    bundleOrNull.bbUpper.setData(arr.filter(c=>c.bbUpper!=null).map(c=>({time:c.time,value:c.bbUpper})));
    bundleOrNull.bbLower.setData(arr.filter(c=>c.bbLower!=null).map(c=>({time:c.time,value:c.bbLower})));
  }else{
    bbMid.setData(DATA.filter(c=>c.bbMid!=null).map(c=>({time:c.time,value:c.bbMid})));
    bbUpper.setData(DATA.filter(c=>c.bbUpper!=null).map(c=>({time:c.time,value:c.bbUpper})));
    bbLower.setData(DATA.filter(c=>c.bbLower!=null).map(c=>({time:c.time,value:c.bbLower})));
  }
}

function setEMASeriesFromArray(arr, bundle){
  if(!bundle) return;
  if (EMA1_ENABLED === "on"){
    const v1 = calcEMAValues(arr, EMA1_PERIOD);
    for(let i=0;i<arr.length;i++) arr[i].ema1 = (v1[i]==null?null:v1[i]);
    bundle.ema1.setData(arr.map((c,i)=> v1[i]==null?null:({time:c.time,value:v1[i]})).filter(Boolean));
  }else{
    for(let i=0;i<arr.length;i++) arr[i].ema1=null;
    bundle.ema1.setData([]);
  }

  if (EMA2_ENABLED === "on"){
    const v2 = calcEMAValues(arr, EMA2_PERIOD);
    for(let i=0;i<arr.length;i++) arr[i].ema2 = (v2[i]==null?null:v2[i]);
    bundle.ema2.setData(arr.map((c,i)=> v2[i]==null?null:({time:c.time,value:v2[i]})).filter(Boolean));
  }else{
    for(let i=0;i<arr.length;i++) arr[i].ema2=null;
    bundle.ema2.setData([]);
  }
}

function calcEMAs(){
  if (EMA1_ENABLED === "on"){
    const v1 = calcEMAValues(DATA, EMA1_PERIOD);
    for(let i=0;i<DATA.length;i++) DATA[i].ema1 = (v1[i]==null?null:v1[i]);
    ema1Series.setData(DATA.map((c,i)=> v1[i]==null?null:({time:c.time,value:v1[i]})).filter(Boolean));
  } else { for(let i=0;i<DATA.length;i++) DATA[i].ema1=null; ema1Series.setData([]); }

  if (EMA2_ENABLED === "on"){
    const v2 = calcEMAValues(DATA, EMA2_PERIOD);
    for(let i=0;i<DATA.length;i++) DATA[i].ema2 = (v2[i]==null?null:v2[i]);
    ema2Series.setData(DATA.map((c,i)=> v2[i]==null?null:({time:c.time,value:v2[i]})).filter(Boolean));
  } else { for(let i=0;i<DATA.length;i++) DATA[i].ema2=null; ema2Series.setData([]); }

  try{
    const p = (EMA1_ENABLED === "on") ? EMA1_PERIOD : 10;
    const ang = computeEmaAngleDeg(DATA, p, 10);
    const bbAng = computeBbMidEmaAngleDeg(DATA, 10, 10);
    const gapInfo = computeEmaBbGapInfo(DATA, 10, 10);
    const superInfo = computeSuperTrendInfoFromEma2(DATA, 10);
    updateAngleBadge(angle1El, ang, bbAng, gapInfo, superInfo);
    updateTrendStrength4(1);
  }catch(_){}
}

function computeEmaAngleDeg(arr, period, lookbackCandles){
  if(!arr || arr.length < 50) return null;
  period = Math.max(1, Math.min(200, Number(period)||10));
  lookbackCandles = Math.max(5, Math.min(60, Number(lookbackCandles)||10));
  const emaVals = calcEMAValues(arr, period);
  if(!emaVals || !emaVals.length) return null;
  let i = emaVals.length - 1;
  while(i > 0 && emaVals[i] === null) i--;
  const j = i - lookbackCandles;
  if(i <= 0 || j < 0) return null;
  if(emaVals[j] === null) return null;

  let sumR = 0, cnt = 0;
  const start = Math.max(0, i - lookbackCandles + 1);
  for(let k=start; k<=i; k++){
    const bar = arr[k];
    const r = (Number(bar.high) - Number(bar.low));
    if(isFinite(r) && r > 0){ sumR += r; cnt++; }
  }
  let avgRange = cnt ? (sumR / cnt) : 0;
  if(!isFinite(avgRange) || avgRange <= 0){
    const px = arr[i] ? Number(arr[i].close) : 1;
    avgRange = Math.max(1e-9, Math.abs(px) * 0.0001);
  }
  const rise = emaVals[i] - emaVals[j];
  const slopeNorm = (rise / avgRange) / lookbackCandles;
  const angle = Math.atan(slopeNorm) * 180 / Math.PI;
  return isFinite(angle) ? angle : null;
}

function computeBbMidEmaAngleDeg(arr, emaPeriod, lookbackCandles){
  if(!arr || arr.length < 50) return null;
  emaPeriod = Math.max(1, Math.min(200, Number(emaPeriod)||10));
  lookbackCandles = Math.max(5, Math.min(60, Number(lookbackCandles)||10));
  const emaVals = calcEMAValues(arr, emaPeriod);
  if(!emaVals || !emaVals.length) return null;
  let i = arr.length - 1;
  while(i > 0){
    const hasE = (emaVals[i] != null);
    const hasM = (arr[i] && arr[i].bbMid != null);
    if(hasE && hasM) break;
    i--;
  }
  const j = i - lookbackCandles;
  if(i <= 0 || j < 0) return null;
  if(emaVals[j] == null) return null;
  if(arr[j] == null || arr[j].bbMid == null) return null;

  let sumR = 0, cnt = 0;
  const start = Math.max(0, i - lookbackCandles + 1);
  for(let k=start; k<=i; k++){
    const bar = arr[k];
    const r = (Number(bar.high) - Number(bar.low));
    if(isFinite(r) && r > 0){ sumR += r; cnt++; }
  }
  let avgRange = cnt ? (sumR / cnt) : 0;
  if(!isFinite(avgRange) || avgRange <= 0){
    const px = arr[i] ? Number(arr[i].close) : 1;
    avgRange = Math.max(1e-9, Math.abs(px) * 0.0001);
  }
  const emaRise = emaVals[i] - emaVals[j];
  const midRise = Number(arr[i].bbMid) - Number(arr[j].bbMid);
  const emaSlope = (emaRise / avgRange) / lookbackCandles;
  const midSlope = (midRise / avgRange) / lookbackCandles;
  const denom = (1 + (emaSlope * midSlope));
  const ratio = Math.abs(emaSlope - midSlope) / (Math.abs(denom) < 1e-9 ? 1e-9 : denom);
  const ang = Math.atan(Math.abs(ratio)) * 180 / Math.PI;
  return isFinite(ang) ? ang : null;
}

function computeEmaBbGapInfo(arr, emaPeriod=10, lookbackCandles=10){
  if(!arr || !arr.length) return null;
  emaPeriod = Math.max(1, Math.min(200, Number(emaPeriod) || 10));
  lookbackCandles = Math.max(2, Math.min(100, Number(lookbackCandles) || 10));
  const emaVals = calcEMAValues(arr, emaPeriod);
  const i = arr.length - 1;
  const j = i - lookbackCandles;
  if(j < 0) return null;
  const a0 = arr[i], a1 = arr[j];
  const e0 = emaVals[i], e1 = emaVals[j];
  if(!isFinite(e0) || !isFinite(e1)) return null;
  const u0 = Number(a0.bbUpper), l0 = Number(a0.bbLower);
  const u1 = Number(a1.bbUpper), l1 = Number(a1.bbLower);
  if(!isFinite(u0) || !isFinite(l0) || !isFinite(u1) || !isFinite(l1)) return null;

  const c0 = Number(a0.close);
  const denom0 = (isFinite(c0) && Math.abs(c0) > 0) ? Math.abs(c0) : Math.max(1e-9, Math.abs(e0));
  const distUp0 = Math.abs(u0 - e0);
  const distDn0 = Math.abs(e0 - l0);
  const distUp1 = Math.abs(u1 - e1);
  const distDn1 = Math.abs(e1 - l1);
  const upPct = (distUp0 / denom0) * 100;
  const dnPct = (distDn0 / denom0) * 100;
  const eps = 1e-9;
  const upDir = (distUp0 + eps < distUp1) ? "↓" : (distUp0 > distUp1 + eps) ? "↑" : "→";
  const dnDir = (distDn0 + eps < distDn1) ? "↓" : (distDn0 > distDn1 + eps) ? "↑" : "→";
  const upStrong = (upDir === "↓");
  const dnStrong = (dnDir === "↓");
  const compression = (upStrong && dnStrong);
  return { upPct, dnPct, upDir, dnDir, upStrong, dnStrong, compression };
}

function computeSuperTrendInfoFromEma2(arr, lookbackCandles=10){
  if(!arr || arr.length < 3) return null;
  const i = Math.max(1, arr.length - 2);
  const prev = i - 1;
  const cNow = arr[i] || {};
  const cPrev = arr[prev] || {};
  const eNow  = (typeof cNow.ema2 === "number")  ? cNow.ema2  : ((typeof cNow.close === "number") ? cNow.close : null);
  const ePrev = (typeof cPrev.ema2 === "number") ? cPrev.ema2 : ((typeof cPrev.close === "number") ? cPrev.close : null);
  const uNow  = (typeof cNow.bbUpper === "number") ? cNow.bbUpper : null;
  const uPrev = (typeof cPrev.bbUpper === "number") ? cPrev.bbUpper : null;
  const lNow  = (typeof cNow.bbLower === "number") ? cNow.bbLower : null;
  const lPrev = (typeof cPrev.bbLower === "number") ? cPrev.bbLower : null;
  if(eNow === null || ePrev === null) return null;

  let mode = null;
  let bNow = null, bPrev = null;
  if(uNow !== null && eNow > uNow){ mode = "UP"; bNow = uNow; bPrev = uPrev; }
  else if(lNow !== null && eNow < lNow){ mode = "DOWN"; bNow = lNow; bPrev = lPrev; }
  else return null;
  if(bNow === null || bPrev === null) return null;

  const emaSlope = (eNow - ePrev);
  const bbSlope  = (bNow - bPrev);
  const emaAng   = Math.atan(emaSlope) * 180 / Math.PI;
  const bbAng    = Math.atan(bbSlope)  * 180 / Math.PI;
  const diffDeg  = Math.abs(emaAng - bbAng);
  return { mode, diffDeg, atIdx:i, emaAng, bbAng };
}

function angleMeaning(angle){
  if(angle === null) return { label:"—", tone:"neutral" };
  if(angle <= -40) return { label:"Dump", tone:"bear" };
  if(angle <= -30) return { label:"Strong Bear", tone:"bear" };
  if(angle <= -15) return { label:"Bear", tone:"bear" };
  if(angle <  15) return { label:"Sideways", tone:"flat" };
  if(angle <  30) return { label:"Bull", tone:"bull" };
  if(angle <  40) return { label:"Strong Bull", tone:"bull" };
  return { label:"Explosive", tone:"bull" };
}
function bbEmaAngleMeaning(angle){
  if(angle == null) return { label:"—" };
  if(angle < 5)  return { label:"No Momentum" };
  if(angle < 15) return { label:"Weak" };
  if(angle < 30) return { label:"Building" };
  if(angle < 45) return { label:"Breakout" };
  return { label:"Impulse" };
}

/* ============================
   Turbo ALL-EMA gate
   ============================ */
let EMA_ANGLE_THRESHOLD = 5;
const __emaAngleLatest = {1:null,2:null,3:null,4:null,5:null};
const __emaAnglePrev   = {1:null,2:null,3:null,4:null,5:null};
let __emaAllTrend = null;

function loadEmaAngleThreshold(){
  try{
    const v = Number(localStorage.getItem("emaAngleThreshold"));
    if(isFinite(v) && v >= 1 && v <= 80) EMA_ANGLE_THRESHOLD = v;
  }catch(_){}
}
function saveEmaAngleThreshold(){
  try{ localStorage.setItem("emaAngleThreshold", String(EMA_ANGLE_THRESHOLD)); }catch(_){}
}
function __inRange(v, lo, hi){ return (v!=null && isFinite(v) && v>=lo && v<=hi); }
function __computeAllEmaTrend(){
  const vals = [__emaAngleLatest[1],__emaAngleLatest[2],__emaAngleLatest[3],__emaAngleLatest[4]];
  if(vals.some(v => v==null || !isFinite(v))) return null;
  const allDown = vals.every(v => __inRange(v, -80, -EMA_ANGLE_THRESHOLD));
  const allUp   = vals.every(v => __inRange(v,  EMA_ANGLE_THRESHOLD, 80));
  if(allDown) return "DOWN";
  if(allUp) return "UP";
  return "MIXED";
}
function updateEmaAnglePanelUI(){
  const v = Math.round(Number(EMA_ANGLE_THRESHOLD) || 5);
  if($("emaAngleVal")) $("emaAngleVal").textContent = v + "°";
  if($("emaAngleVal2")) $("emaAngleVal2").textContent = String(v);
  if($("emaAngleVal3")) $("emaAngleVal3").textContent = String(v);
  const lbl = $("emaAllTrendLabel");
  if(lbl){
    const t = (__emaAllTrend || "—");
    lbl.textContent = t;
    lbl.style.color = (t==="UP") ? "#4ade80" : (t==="DOWN") ? "#f87171" : "#e5e7eb";
  }
}
function setEmaAngleThreshold(v){
  v = Math.max(1, Math.min(80, Math.round(Number(v)||5)));
  EMA_ANGLE_THRESHOLD = v;
  saveEmaAngleThreshold();
  __emaAllTrend = __computeAllEmaTrend();
  updateEmaAnglePanelUI();
  recomputeAllSignals();
}
loadEmaAngleThreshold();
if($("emaAngleSlider")){
  $("emaAngleSlider").value = String(EMA_ANGLE_THRESHOLD);
  $("emaAngleSlider").addEventListener("input", (e)=> setEmaAngleThreshold(e.target.value));
}
updateEmaAnglePanelUI();

function filterSignalsByJetDetectorFinal(sigs){
  if(!Array.isArray(sigs)) return [];
  const trend = __emaAllTrend;
  if(trend === "UP")   return sigs.filter(s => s.dir === "buy"  || s.dir === "close");
  if(trend === "DOWN") return sigs.filter(s => s.dir === "sell" || s.dir === "close");
  return sigs.filter(s => s.dir === "close");
}

function __applyAllTrendToBadges(){
  const suffix = __emaAllTrend ? ` • ALL EMA: ${__emaAllTrend}` : "";
  for(let i=1;i<=4;i++){
    const el = $("angle"+i);
    if(!el) continue;
    const base = String(el.dataset.baseText || el.textContent || "—");
    if(el.dataset.baseText){
      if(base.includes("ALL EMA:")) el.textContent = base;
      else el.textContent = base + suffix;
    }else{
      el.textContent = (base.includes("ALL EMA:") ? base : base + suffix);
    }
    if(__emaAllTrend === "DOWN"){
      el.style.background  = "rgba(239, 68, 68, 0.10)";
      el.style.boxShadow   = "0 0 14px rgba(239, 68, 68, 0.35)";
      el.style.borderColor = "#ef4444";
    }else if(__emaAllTrend === "UP"){
      el.style.background  = "rgba(34, 197, 94, 0.10)";
      el.style.boxShadow   = "0 0 14px rgba(34, 197, 94, 0.35)";
      el.style.borderColor = "#22c55e";
    }else{
      el.style.boxShadow = "";
    }
  }
}

function updateAngleBadge(el, emaAngle, bbEmaAngle, gapInfo, superInfo){
  if(!el) return;
  try{
    const m = (el.id || "").match(/angle(\d+)/);
    if(m){
      const k = Number(m[1]);
      __emaAnglePrev[k] = __emaAngleLatest[k];
      __emaAngleLatest[k] = (emaAngle==null?null:Number(emaAngle));
    }
  }catch(_){}
  __emaAllTrend = __computeAllEmaTrend();
  updateEmaAnglePanelUI();

  const m1 = angleMeaning(emaAngle);
  const m2 = bbEmaAngleMeaning(bbEmaAngle);
  const __fmtDeg = (v)=> (v==null || !isFinite(v)) ? "—" : (Number(v).toFixed(1) + "°");
  const deg1 = __fmtDeg(emaAngle);
  const deg2 = __fmtDeg(bbEmaAngle);

  let gapText = "";
  if(gapInfo){
    const lPct = isFinite(gapInfo.dnPct) ? gapInfo.dnPct.toFixed(2) : "—";
    const uPct = isFinite(gapInfo.upPct) ? gapInfo.upPct.toFixed(2) : "—";
    gapText = ` | LGap: ${lPct}% • ${gapInfo.dnDir} | UGap: ${uPct}% • ${gapInfo.upDir}`;
    if(gapInfo.compression) gapText += ` | Compression`;
  }

  let superLine = "";
  if(superInfo && superInfo.mode){
    const sDeg = (isFinite(superInfo.diffDeg) ? superInfo.diffDeg.toFixed(1) : "—");
    superLine = (superInfo.mode === "UP")
      ? `ULTRA UP TREND • Δ${sDeg}°`
      : `ULTRA DOWN TREND • Δ${sDeg}°`;
  }

  const text = `Turbo Scan: ${deg1} • ${m1.label} | BB↔EMA: ${deg2} • ${m2.label}${gapText}`;
  el.dataset.baseText = (superLine ? (superLine + " | " + text) : text);
  el.textContent = el.dataset.baseText + (__emaAllTrend ? ` • ALL EMA: ${__emaAllTrend}` : "");

  if(m1.tone === "bear"){ el.style.color="#fca5a5"; el.style.borderColor="#7f1d1d"; }
  else if(m1.tone === "bull"){ el.style.color="#86efac"; el.style.borderColor="#14532d"; }
  else { el.style.color="#9eb1c7"; el.style.borderColor="#1e293b"; }

  __applyAllTrendToBadges();
}

/* ============================
   Trend strength UI
   ============================ */
function updateTrendStrength4(slot){
  const indEl = $("ind"+slot);
  if(!indEl) return;
  const tfMap = {1:"1h",2:"2h",3:"4h",4:"1d"};
  const tf = tfMap[slot] || ("TF"+slot);

  if(!indEl.dataset || indEl.dataset.kind !== "trendH"){
    indEl.dataset.kind = "trendH";
    indEl.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;width:100%;">
        <div class="hTrack" style="width:min(520px, 100%);">
          <div class="hMid"></div>
          <div class="hCandle" id="trendCandle${slot}">
            <div class="hFill" id="trendFill${slot}"></div>
          </div>
        </div>
        <div class="hMeta" style="width:min(520px, 100%);">
          <span class="tfTag">${tf}</span>
          <span class="jetTag" id="trendJet${slot}">—°</span>
          <span class="pctTag" id="trendPct${slot}">—%</span>
          <span class="pctSub" id="trendSub${slot}">trend</span>
        </div>
      </div>
    `;
  }

  const candle = $("trendCandle"+slot);
  const fill = $("trendFill"+slot);
  const pctEl = $("trendPct"+slot);
  const subEl = $("trendSub"+slot);
  const jetEl = $("trendJet"+slot);

  const cur = __emaAngleLatest[slot];
  const prev = __emaAnglePrev[slot];
  let dir = "range";
  let delta = null;

  if(cur!=null && prev!=null && isFinite(cur) && isFinite(prev)){
    delta = cur - prev;
    if(delta > 0.05) dir = "up";
    else if(delta < -0.05) dir = "down";
  }
  if(jetEl){
    const cTxt = (cur==null||!isFinite(cur)) ? "—°" : (cur.toFixed(1)+"°");
    jetEl.textContent = cTxt;
  }

  const maxDelta = 10;
  let strength = 0;
  if(delta!=null && isFinite(delta)) strength = Math.min(1, Math.abs(delta)/maxDelta);
  const pct = Math.round(strength*100);
  if(pctEl) pctEl.textContent = pct+"%";
  if(subEl) subEl.textContent = (dir==="up")?"UP trend":(dir==="down")?"DOWN trend":"RANGE";

  requestAnimationFrame(()=>{
    if(!candle || !fill) return;
    const w = Math.max(0, Math.min(100, strength*100));
    fill.style.left="0%";
    fill.style.width=w.toFixed(1)+"%";
    const alpha = (0.10 + 0.90*strength);
    fill.style.opacity = (0.25 + 0.75*strength).toFixed(3);
    if(dir==="up"){
      fill.style.background=`rgba(34,197,94,${alpha.toFixed(3)})`;
      candle.style.borderColor=`rgba(22,163,74,0.85)`;
    }else if(dir==="down"){
      fill.style.background=`rgba(239,68,68,${alpha.toFixed(3)})`;
      candle.style.borderColor=`rgba(220,38,38,0.85)`;
    }else{
      fill.style.background=`rgba(148,163,184,${(0.10+0.40*strength).toFixed(3)})`;
      candle.style.borderColor=`rgba(30,41,59,0.95)`;
    }
  });
}

function updateJetCandleIndicator(angleDeg, lastDir){
  const indEl = $("ind5");
  if(!indEl) return;
  const needsBuild = (!indEl.dataset || indEl.dataset.kind !== "jetH" || !$("jetCandleBar") || !$("jetFill"));
  if(needsBuild){
    indEl.dataset.kind = "jetH";
    indEl.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;width:100%;">
        <div class="hTrack jet" style="width:100%;max-width:760px;">
          <div class="hMid"></div>
          <div class="hCandle" id="jetCandleBar">
            <div class="hFill" id="jetFill"></div>
          </div>
        </div>
        <div class="hMeta" style="width:100%;max-width:760px;">
          <span class="tfTag">15m</span>
          <span class="pctTag" id="jetPct">—%</span>
          <span class="pctSub" id="jetInfo">—</span>
        </div>
      </div>
    `;
  }
  const candle = $("jetCandleBar");
  const fill = $("jetFill");
  const pctEl = $("jetPct");
  const infoEl = $("jetInfo");

  const a = (angleDeg==null || !isFinite(angleDeg)) ? null : Number(angleDeg);
  const absA = (a==null)?0:Math.abs(a);

  let delta = null;
  if(a!=null){
    const prev = (typeof window.__jetPrevAngle === "number") ? window.__jetPrevAngle : null;
    if(prev!=null) delta = a - prev;
    window.__jetPrevAngle = a;
  }
  let jetTrend="RANGE";
  if(delta!=null && isFinite(delta)){
    if(delta>0.05) jetTrend="UP";
    else if(delta<-0.05) jetTrend="DOWN";
  }

  const thr = (isFinite(EMA_ANGLE_THRESHOLD)?EMA_ANGLE_THRESHOLD:5);
  const strength = Math.max(0, Math.min(1, (absA - thr) / (80 - thr)));
  const pct = Math.round(strength*100);
  if(pctEl) pctEl.textContent = pct+"%";

  let dir = (lastDir==="buy"||lastDir==="sell") ? lastDir : null;
  if(!dir) dir = (a!=null && a>=0) ? "buy" : "sell";

  if(infoEl){
    const s = (dir==="buy")?"BUY":"SELL";
    const aTxt = (a!=null)?(a.toFixed(1)+"°"):"—";
    const dTxt = (delta!=null)?(((delta>=0?"+":"")+delta.toFixed(2))+"°"):"—";
    infoEl.textContent = `${s} • ${aTxt} • Δ ${dTxt} • ${jetTrend}`;
    infoEl.style.color = (dir==="buy") ? "#4ade80" : "#f87171";
  }

  requestAnimationFrame(()=>{
    if(!candle || !fill) return;
    const w = Math.max(0, Math.min(100, strength*100));
    fill.style.left="0%";
    fill.style.width=w.toFixed(1)+"%";
    const alpha = (0.10 + 0.90*strength);
    fill.style.opacity = (0.25 + 0.75*strength).toFixed(3);
    if(dir==="buy"){
      fill.style.backgroundColor=`rgba(34,197,94,${alpha.toFixed(3)})`;
      candle.style.borderColor=`rgba(22,163,74,0.85)`;
    }else{
      fill.style.backgroundColor=`rgba(239,68,68,${alpha.toFixed(3)})`;
      candle.style.borderColor=`rgba(220,38,38,0.85)`;
    }
  });
}

/* ============================
   Signal detection + markers
   ============================ */
function applyMarkersToSeries(series, sigs){
  const markers = (sigs || []).map(s=>{
    const isBuy = (s.dir === 'buy');
    const isSell = (s.dir === 'sell');
    const isClose = (s.dir === 'close');
    return {
      time: s.time,
      position: isBuy ? "belowBar" : "aboveBar",
      color: isBuy ? '#22c55e' : (isSell ? '#ef4444' : '#eab308'),
      shape: isBuy ? 'arrowUp' : (isSell ? 'arrowDown' : 'circle'),
      text: isClose ? "CLOSE" : (isBuy ? "BUY" : "SELL")
    };
  });
  series.setMarkers(markers);
}

function detectSignalsOnArray(arr, symbol, tf, maxIdx){
  const sigs = [];
  if (!arr || arr.length < 25) return sigs;
  if (EMA2_ENABLED !== "on") return sigs;

  const ema2Vals = calcEMAValues(arr, EMA2_PERIOD);
  let endIdx = arr.length - 1;
  if (typeof maxIdx === "number" && isFinite(maxIdx)) endIdx = Math.min(endIdx, Math.floor(maxIdx));
  if (endIdx < 2) return sigs;

  let openPos = null;

  for (let i = 1; i <= endIdx; i++){
    const prev = arr[i - 1];
    const c    = arr[i];
    if (!prev || !c) continue;
    if (prev.bbUpper == null || prev.bbLower == null || c.bbUpper == null || c.bbLower == null) continue;

    const ePrev = ema2Vals[i - 1];
    const eNow  = ema2Vals[i];
    if (!isFinite(ePrev) || !isFinite(eNow)) continue;

    const sellCross = (ePrev >= prev.bbLower) && (eNow < c.bbLower);
    const buyCross  = (ePrev <= prev.bbUpper) && (eNow > c.bbUpper);

    if (buyCross){
      openPos = "buy";
      sigs.push({
        time: c.time,
        dir: "buy",
        price: c.close,
        symbol, tf,
        label: "B Plus Gaing Momentum break BUY"
      });
    } else if (sellCross){
      openPos = "sell";
      sigs.push({
        time: c.time,
        dir: "sell",
        price: c.close,
        symbol, tf,
        label: "B Plus Gaing Momentum break SELL"
      });
    } else {
      if(openPos === "buy" && ePrev > prev.bbUpper && eNow <= c.bbUpper){
        sigs.push({ time:c.time, dir:"close", price:c.close, symbol, tf, label:"CLOSE BUY" });
        openPos = null;
      }
      if(openPos === "sell" && ePrev < prev.bbLower && eNow >= c.bbLower){
        sigs.push({ time:c.time, dir:"close", price:c.close, symbol, tf, label:"CLOSE SELL" });
        openPos = null;
      }
    }
  }
  return sigs;
}

function detectSignalsMain(maxIdx){
  return detectSignalsOnArray(DATA, $("symbol").value, $("tf").value, maxIdx);
}

function applyMarkers(){
  applyMarkersToSeries(candleSeries, SIGNALS || []);
}

/* ============================
   Signal list rendering
   ============================ */
function buildSignalToastHtml(s, bg, font){
  const dirCls = (s.dir==="buy")?"toast-dir-buy":(s.dir==="sell")?"toast-dir-sell":"";
  const dirTxt = (s.dir||"").toUpperCase();
  const tpText = (s.tp!=null) ? `TP ${__fmtNum(s.tp)}` : "";
  const ts = new Date((Number(s.time)||0)*1000).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});

  const marketName = String(s.symbol||"");
  const tfName = String(s.tf||"");

  return `
    <div class="toast-card" style="background:${bg};color:${font};border-color:#1f2937;">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <span class="symbol">${marketName}</span>
        <span class="toast-title" style="font-weight:800;">${tfName}</span>
        <span style="color:#64748b;">•</span>
        <span style="font-size:12px;color:#cbd5e1;font-weight:800;">${dirTxt}</span>
      </div>
      <div class="${dirCls}">${dirTxt} • ${String(s.label||"")}</div>
      <div class="toast-entry">Entry: ${__fmtNum(s.price)}</div>
      ${tpText ? `<div class="toast-tp" style="background:${TP_BG_COLOR};color:${TP_FONT_COLOR};">${tpText}</div>` : ``}
      <div class="toast-time">${ts}</div>
    </div>
  `;
}

function renderSignals(){
  const listEl = $("sig-list");
  if(!listEl) return;

  const filterTf = ($("sigTfFilter") && $("sigTfFilter").value) ? $("sigTfFilter").value : "all";
  const nowSec = Math.floor(Date.now()/1000);
  const recent = (GLOBAL_SIGNALS || []).filter(s => (nowSec - (Number(s.time)||nowSec)) <= 15*60);
  const filtered = (filterTf==="all") ? recent : recent.filter(s => String(s.tf||"") === filterTf);
  filtered.sort((a,b)=> (b.time||0)-(a.time||0));

  if(!filtered.length){
    listEl.innerHTML = `<div style="padding:6px 2px;">No signals in last 15 minutes.</div>`;
    return;
  }

  listEl.innerHTML = filtered.slice(0, 120).map(s=>{
    const dirCls = (s.dir==="buy")?"buy":(s.dir==="sell")?"sell":"close";
    const ts = new Date((Number(s.time)||0)*1000).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    return `
      <div class="sig-card">
        <div><span class="symbol">${String(s.symbol||"")}</span> <span class="${dirCls}">${String(s.dir||"").toUpperCase()}</span></div>
        <!-- ✅ TF renamed -->
        <div class="price">Entry: ${__fmtNum(s.price)} <span style="color:#64748b;">•</span> Interval: ${String(s.tf||"")}</div>
        ${s.tp!=null ? `<div class="tp" style="background:${TP_BG_COLOR};color:${TP_FONT_COLOR};">TP ${__fmtNum(s.tp)}</div>` : ``}
        <div class="time">${ts} • ${String(s.label||"")}</div>
      </div>
    `;
  }).join("");
}

/* ============================
   AI plan (rule-based placeholder)
   ============================ */
let __lastAiPlan = null;
const __engineLastByTf = {};

function __tfRank(tf){
  const t = String(tf||"").toLowerCase();
  if (t==="1h") return 5;
  if (t==="30m") return 4;
  if (t==="15m") return 3;
  if (t==="5m") return 2;
  if (t==="1m") return 1;
  return 0;
}
function __secToTimeStr(sec){
  if(!sec) return "—";
  const d = new Date(sec*1000);
  return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
}
function __pickEngineFinal(){
  const list = Object.values(__engineLastByTf).filter(Boolean);
  if (!list.length) return { bias:"WAIT", tf:null, time:null, price:null };
  list.sort((a,b)=>{
    const rb = __tfRank(b.tf) - __tfRank(a.tf);
    if (rb!==0) return rb;
    return (b.time||0) - (a.time||0);
  });
  const s = list[0];
  const bias = (s.dir==="buy") ? "BUY" : (s.dir==="sell" ? "SELL" : "WAIT");
  return { bias, tf:s.tf, time:s.time, price:s.price };
}

function scheduleAiPlan(reason){
  const eng = __pickEngineFinal();
  let bias = "WAIT";
  let conf = 0;
  const turbo = (__emaAllTrend || "—");
  if(turbo === "MIXED" || turbo === null){
    bias = "WAIT";
    conf = 0;
  }else{
    bias = eng.bias;
    conf = (bias==="WAIT") ? 0 : 62;
  }

  __lastAiPlan = { bias, confidence: conf, entry: eng.price, sl: null, tp: null, reason:`Turbo=${turbo}, Core=${eng.bias}` };
  if($("aiPlanStatus")) $("aiPlanStatus").textContent = reason ? String(reason) : "—";
  if($("aiBias")) $("aiBias").textContent = bias;
  if($("aiConf")) $("aiConf").textContent = `${Math.max(0,Math.min(100,conf))}%`;
  if($("aiEntry")) $("aiEntry").textContent = (eng.price==null) ? "—" : __fmtNum(eng.price);
  if($("aiSL")) $("aiSL").textContent = "—";
  if($("aiTP")) $("aiTP").textContent = "—";
  if($("aiReason")) $("aiReason").textContent = __lastAiPlan.reason || "—";
  if($("aiInvalid")) $("aiInvalid").textContent = "Turbo changes / opposite signal";

  __renderAiVsEngine();
}

function __renderAiVsEngine(){
  const eng = __pickEngineFinal();
  const ai = (__lastAiPlan && __lastAiPlan.bias) ? String(__lastAiPlan.bias).toUpperCase() : "WAIT";
  const conf = (__lastAiPlan && typeof __lastAiPlan.confidence==="number") ? __lastAiPlan.confidence : null;

  if ($("cmpEngine")) $("cmpEngine").textContent = eng.bias;
  if ($("cmpEngineMeta")){
    const p = (eng.price==null) ? "—" : __fmtNum(eng.price);
    $("cmpEngineMeta").textContent = eng.tf ? `${eng.tf} • ${__secToTimeStr(eng.time)} • ${p}` : "—";
  }
  if ($("cmpAI")) $("cmpAI").textContent = ai || "WAIT";
  if ($("cmpAIMeta")) $("cmpAIMeta").textContent = (conf==null) ? "—" : `Conf ${Math.max(0,Math.min(100,conf))}%`;

  let status = "—";
  let decision = "—";
  const turbo = (__emaAllTrend || "").toUpperCase().trim();

  if (turbo==="MIXED"){
    status = "WAIT";
    decision = "Turbo Detector Final = MIXED → block entries and wait.";
  } else if (ai==="WAIT"){
    status = "AI WAIT";
    decision = "OpenAI panel = WAIT → no entry.";
  } else if (eng.bias==="WAIT"){
    status = "ENGINE WAIT";
    decision = "Core has no recent signal → treat as WAIT.";
  } else if (ai===eng.bias){
    status = "MATCH";
    decision = `AI and Core agree: ${ai}.`;
  } else {
    status = "MISMATCH";
    decision = `AI=${ai} but Core=${eng.bias}. Recommended: WAIT (avoid conflict).`;
  }

  if ($("cmpStatus")) $("cmpStatus").textContent = status;
  if ($("cmpDecision")) $("cmpDecision").textContent = decision;
}

/* ============================
   BINANCE (simplified)
   ============================ */
let BINANCE_SYMBOLS = [];
let BINANCE_FUTURES_SYMBOLS = [];
let BIN_WS = null;

const BINANCE_RELAY_WSS = "wss://ws.derivesupanalyzer.site/";
const BINANCE_SPOT_WSS_BASE = "wss://stream.binance.com:9443/ws/";
const BINANCE_FUTURES_WSS_BASE = "wss://fstream.binance.com/ws/";

async function __tryFetchJson(url){
  const r = await fetch(url, { cache: "no-store" });
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}

async function fetchBinanceExchangeInfoSpot(){
  const urls = [
    "https://api.binance.com/api/v3/exchangeInfo",
    "https://api1.binance.com/api/v3/exchangeInfo",
    "https://api2.binance.com/api/v3/exchangeInfo",
    "https://api3.binance.com/api/v3/exchangeInfo",
    "https://data-api.binance.vision/api/v3/exchangeInfo"
  ];
  let lastErr=null;
  for(const u of urls){ try{ return await __tryFetchJson(u); }catch(e){ lastErr=e; } }
  throw lastErr || new Error("spot exchangeInfo failed");
}
async function fetchBinanceExchangeInfoFutures(){
  const urls = [
    "https://fapi.binance.com/fapi/v1/exchangeInfo",
    "https://fstream.binance.com/fapi/v1/exchangeInfo",
    "https://data.binance.vision/fapi/v1/exchangeInfo"
  ];
  let lastErr=null;
  for(const u of urls){ try{ return await __tryFetchJson(u); }catch(e){ lastErr=e; } }
  throw lastErr || new Error("futures exchangeInfo failed");
}

async function fetchBinanceSpotSymbols(){
  try{
    const j = await __tryFetchJson("/api/symbols?market=spot");
    const arr = Array.isArray(j && j.symbols) ? j.symbols : [];
    if(arr.length) return arr.map(s => ({ symbol:s.symbol, baseAsset:s.baseAsset, quoteAsset:s.quoteAsset }));
  }catch(_){}
  const info = await fetchBinanceExchangeInfoSpot();
  const symbols = Array.isArray(info && info.symbols) ? info.symbols : [];
  return symbols
    .filter(s => s && s.status === "TRADING" && (s.isSpotTradingAllowed !== false))
    .map(s => ({ symbol:s.symbol, baseAsset:s.baseAsset, quoteAsset:s.quoteAsset }));
}
async function fetchBinanceFuturesSymbols(){
  try{
    const j = await __tryFetchJson("/api/symbols?market=futures");
    const arr = Array.isArray(j && j.symbols) ? j.symbols : [];
    if(arr.length) return arr.map(s => ({ symbol:s.symbol, baseAsset:s.baseAsset, quoteAsset:s.quoteAsset }));
  }catch(_){}
  const info = await fetchBinanceExchangeInfoFutures();
  const symbols = Array.isArray(info && info.symbols) ? info.symbols : [];
  return symbols
    .filter(s => s && s.status === "TRADING" && s.contractType === "PERPETUAL")
    .map(s => ({ symbol:s.symbol, baseAsset:s.baseAsset, quoteAsset:s.quoteAsset }));
}

function fillBinanceGroupOptions(list){
  const group = document.getElementById("binanceGroup");
  if(!group) return;
  group.innerHTML = "";
  const sorted = (list || []).slice().sort((a,b)=> (a.symbol||"").localeCompare(b.symbol||""));
  for(const s of sorted){
    const sym = s && s.symbol ? String(s.symbol) : "";
    if(!sym) continue;
    const opt = document.createElement("option");
    opt.value = "bn:" + sym;
    const base = s.baseAsset || "";
    const quote = s.quoteAsset || "";
    opt.textContent = (base && quote) ? `${base}/${quote}` : sym;
    group.appendChild(opt);
  }
}
function fillBinanceFuturesGroupOptions(list){
  const group = document.getElementById("binanceFuturesGroup");
  if(!group) return;
  group.innerHTML = "";
  const sorted = (list || []).slice().sort((a,b)=> (a.symbol||"").localeCompare(b.symbol||""));
  for(const s of sorted){
    const sym = s && s.symbol ? String(s.symbol) : "";
    if(!sym) continue;
    const opt = document.createElement("option");
    opt.value = "bf:" + sym;
    const base = s.baseAsset || "";
    const quote = s.quoteAsset || "";
    opt.textContent = (base && quote) ? `${base}/${quote}` : sym;
    group.appendChild(opt);
  }
}

function fillDerivGroupOptions(){
  const group = $("derivGroup");
  if(!group) return;
  group.innerHTML = "";
  for(const sym of (ALL_SYMBOLS||[])){
    const opt = document.createElement("option");
    opt.value = "dv:" + sym;
    opt.textContent = sym;
    group.appendChild(opt);
  }
}

function toBinanceInterval(tf){
  const ok = new Set(["1m","3m","5m","15m","30m","1h","2h","4h","6h","8h","12h","1d","3d","1w","1M"]);
  if(ok.has(tf)) return tf;
  const map = {"10m":"15m"};
  return map[tf] || "5m";
}

async function fetchBinanceKlines(symbol, interval, limit=600, market="spot"){
  const isFutures = String(market||"").toLowerCase().startsWith("fut");
  try{
    const r = await fetch(`/api/klines?market=${encodeURIComponent(isFutures ? "futures" : "spot")}&symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${encodeURIComponent(limit)}`, { cache:"no-store" });
    if(r.ok){
      const j = await r.json();
      if(j && Array.isArray(j.klines)) return j.klines;
    }
  }catch(_){}
  const base = isFutures ? "https://fapi.binance.com" : "https://api.binance.com";
  const path = isFutures ? "/fapi/v1/klines" : "/api/v3/klines";
  const urls = [
    `${base}${path}?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${limit}`,
    (!isFutures ? `https://data-api.binance.vision/api/v3/klines?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${limit}` : `https://data.binance.vision/fapi/v1/klines?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${limit}`)
  ].filter(Boolean);
  let lastErr=null;
  for(const u of urls){
    try{
      const r=await fetch(u,{cache:"no-store"});
      if(!r.ok) throw new Error("HTTP "+r.status);
      const j = await r.json();
      if(Array.isArray(j)) return j;
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error("Binance klines failed");
}

function closeBinanceWS(){
  try{ if(BIN_WS){ BIN_WS.close(); } }catch(_){}
  BIN_WS=null;
  for(const b of [chart2Bundle, chart3Bundle, chart4Bundle, chart5Bundle]){
    try{ if(b && b.binWs){ b.binWs.close(); } }catch(_){}
    if(b) b.binWs=null;
  }
}

function __extractKline(evData){
  try{
    const msg = (typeof evData === "string") ? JSON.parse(evData||"{}") : (evData||{});
    const k = (msg && msg.k) ? msg.k : (msg && msg.data && msg.data.k ? msg.data.k : null);
    if(!k) return null;
    const t = Math.floor((k.t||0)/1000);
    const o = parseFloat(k.o), h = parseFloat(k.h), l = parseFloat(k.l), c = parseFloat(k.c);
    const closed = !!k.x;
    if(!t || !isFinite(o) || !isFinite(h) || !isFinite(l) || !isFinite(c)) return null;
    return { t, o, h, l, c, closed };
  }catch(_){ return null; }
}

function __buildWsUrl(symbol, interval, market){
  const isFutures = String(market||"").toLowerCase().startsWith("fut");
  if(isFutures) return `${BINANCE_FUTURES_WSS_BASE}${String(symbol||"").toLowerCase()}@kline_${interval}`;
  return `${BINANCE_RELAY_WSS}?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}`;
}
function __buildSpotFallbackWsUrl(symbol, interval){
  return `${BINANCE_SPOT_WSS_BASE}${String(symbol||"").toLowerCase()}@kline_${interval}`;
}

function startBinanceKlineStream(symbol, interval, market="spot"){
  closeBinanceWS();
  try{
    const isFutures = String(market||"").toLowerCase().startsWith("fut");
    let usedFallback = false;
    const openWs = (url)=>{
      BIN_WS = new WebSocket(url);
      BIN_WS.onmessage = (ev)=>{
        const k = __extractKline(ev.data);
        if(!k) return;
        const {t,o,h,l,c,closed} = k;
        const last = DATA.length ? DATA[DATA.length-1] : null;
        if(last && last.time === t){
          last.open=o; last.high=h; last.low=l; last.close=c;
        }else if(!last || t > (last.time||0)){
          DATA.push({time:t, open:o, high:h, low:l, close:c});
          if(DATA.length > 800) DATA = DATA.slice(-800);
        }
        candleSeries.update({ time:t, open:o, high:h, low:l, close:c });
        if(closed){
          recomputeAllSignals();
        }
      };
      BIN_WS.onerror = ()=>{
        if(!isFutures && !usedFallback){
          usedFallback=true;
          try{ BIN_WS.close(); }catch(_){}
          BIN_WS=null;
          try{ openWs(__buildSpotFallbackWsUrl(symbol, interval)); }catch(_){}
        }
      };
    };
    openWs(__buildWsUrl(symbol, interval, market));
  }catch(e){}
}

function startBinanceKlineStreamToBundle(bundle, symbol, interval, tfLabel, market="spot"){
  if(!bundle) return;
  try{ if(bundle.binWs){ bundle.binWs.close(); } }catch(_){}
  bundle.binWs=null;

  try{
    const isFutures = String(market||"").toLowerCase().startsWith("fut");
    let usedFallback=false;

    const openWs = (url)=>{
      const ws = new WebSocket(url);
      bundle.binWs = ws;

      ws.onmessage = (ev)=>{
        const k = __extractKline(ev.data);
        if(!k) return;
        const {t,o,h,l,c,closed} = k;

        const arr = bundle.data || [];
        const last = arr.length ? arr[arr.length-1] : null;
        if(last && last.time===t){
          last.open=o; last.high=h; last.low=l; last.close=c;
        }else if(!last || t > (last.time||0)){
          arr.push({time:t, open:o, high:h, low:l, close:c});
          bundle.data = (arr.length>800) ? arr.slice(-800) : arr;
        }
        bundle.series.update({ time:t, open:o, high:h, low:l, close:c });
        if(closed){
          try{ renderStrategyToBundle(bundle, bundle.data, symbol, tfLabel); }catch(_){}
        }
      };

      ws.onerror = ()=>{
        if(!isFutures && !usedFallback){
          usedFallback=true;
          try{ ws.close(); }catch(_){}
          try{ openWs(__buildSpotFallbackWsUrl(symbol, interval)); }catch(_){}
        }
      };
    };

    openWs(__buildWsUrl(symbol, interval, market));
  }catch(_){}
}

async function initBinanceMarkets(){
  try{
    const [spot, fut] = await Promise.all([
      fetchBinanceSpotSymbols().catch(()=>[]),
      fetchBinanceFuturesSymbols().catch(()=>[])
    ]);
    BINANCE_SYMBOLS = Array.isArray(spot) ? spot : [];
    BINANCE_FUTURES_SYMBOLS = Array.isArray(fut) ? fut : [];
    fillBinanceGroupOptions(BINANCE_SYMBOLS);
    fillBinanceFuturesGroupOptions(BINANCE_FUTURES_SYMBOLS);
    const sel = $("symbol");
    if(sel){
      const def = "bn:BTCUSDT";
      if(sel.querySelector(`option[value="${def}"]`)) sel.value = def;
    }
  }catch(_){}
}

/* ============================
   Deriv candles (basic)
   ============================ */
let WS = null;
function closeDerivWS(){
  try{ if(WS){ WS.close(); } }catch(_){}
  WS=null;
}

function derivGranularity(tf){
  const map = {"1m":60,"2m":120,"5m":300,"10m":600,"15m":900,"30m":1800,"1h":3600,"2h":7200,"4h":14400,"1d":86400,"1D":86400};
  return map[String(tf||"").toLowerCase()] || 300;
}

function derivFetchCandles(symbol, tf, count=600){
  const gran = derivGranularity(tf);
  return new Promise((resolve, reject)=>{
    try{
      const ws = new WebSocket(WS_URL);
      const timer = setTimeout(()=>{ try{ws.close();}catch(_){ } reject(new Error("Deriv candles timeout")); }, 9000);
      ws.onopen = ()=>{
        ws.send(JSON.stringify({ ticks_history: symbol, style:"candles", end:"latest", count, granularity: gran }));
      };
      ws.onmessage = (ev)=>{
        const msg = JSON.parse(ev.data||"{}");
        if(msg.error){ clearTimeout(timer); try{ws.close();}catch(_){ } reject(new Error(msg.error.message||"Deriv error")); return; }
        if(msg.msg_type === "candles" && Array.isArray(msg.candles)){
          clearTimeout(timer);
          try{ws.close();}catch(_){ }
          resolve(msg.candles);
        }
      };
      ws.onerror = ()=>{ clearTimeout(timer); try{ws.close();}catch(_){ } reject(new Error("Deriv socket error")); };
    }catch(e){ reject(e); }
  });
}

function startDerivLive(symbol, tf){
  closeDerivWS();
  const gran = derivGranularity(tf);
  WS = new WebSocket(WS_URL);
  WS.onopen = ()=>{
    if(API_TOKEN){
      WS.send(JSON.stringify({ authorize: API_TOKEN }));
    }
    WS.send(JSON.stringify({ ticks_history: symbol, style:"candles", end:"latest", count: 2, granularity: gran, subscribe: 1 }));
  };
  WS.onmessage = (ev)=>{
    try{
      const msg = JSON.parse(ev.data||"{}");
      if(msg.error) return;
      if(msg.msg_type === "candles" && Array.isArray(msg.candles)){
        return;
      }
      if(msg.msg_type === "ohlc" && msg.ohlc){
        const o = msg.ohlc;
        const t = Number(o.open_time);
        const open=Number(o.open), high=Number(o.high), low=Number(o.low), close=Number(o.close);
        const last = DATA.length ? DATA[DATA.length-1] : null;
        if(last && last.time === t){
          last.open=open; last.high=high; last.low=low; last.close=close;
        }else if(!last || t > (last.time||0)){
          DATA.push({time:t, open, high, low, close});
          if(DATA.length > 800) DATA = DATA.slice(-800);
        }
        candleSeries.update({time:t, open, high, low, close});
        if(o.is_final){
          recomputeAllSignals();
        }
      }
    }catch(_){}
  };
  WS.onerror = ()=>{};
  WS.onclose = ()=>{};
}

/* ============================
   Bundle render (Interval2..Interval5)
   ============================ */
function renderStrategyToBundle(bundle, arr, symbol, tf){
  if(!bundle || !arr) return;
  calcBBForArray(arr);
  setBBSeriesFromArray(arr, bundle);
  setEMASeriesFromArray(arr, bundle);

  const p = (EMA1_ENABLED === "on") ? EMA1_PERIOD : 10;
  const ang = computeEmaAngleDeg(arr, p, 10);
  const bbAng = computeBbMidEmaAngleDeg(arr, 10, 10);
  const gapInfo = computeEmaBbGapInfo(arr, 10, 10);
  const superInfo = computeSuperTrendInfoFromEma2(arr, 10);
  updateAngleBadge(bundle.angleEl, ang, bbAng, gapInfo, superInfo);

  const sigsRaw = detectSignalsOnArray(arr, symbol, tf, Math.max(0, arr.length-2));
  const sigs = filterSignalsByJetDetectorFinal(sigsRaw);
  applyMarkersToSeries(bundle.series, sigs);

  const m = (bundle.angleEl && bundle.angleEl.id) ? bundle.angleEl.id.match(/angle(\d+)/) : null;
  const slot = m ? Number(m[1]) : null;
  if(slot>=1 && slot<=4) updateTrendStrength4(slot);
  if(slot===5){
    const last = sigs.length ? sigs[sigs.length-1] : null;
    updateJetCandleIndicator(ang, last ? last.dir : null);
  }

  if(sigs.length){
    const last = sigs[sigs.length-1];
    __engineLastByTf[String(tf||"").toLowerCase()] = last;
  }
  scheduleAiPlan("bundle_update");
}

/* ============================
   MASTER recompute
   ============================ */
let __lastNotifiedKey = null;

function recomputeAllSignals(){
  if(!Array.isArray(DATA) || DATA.length<25) return;

  calcBBForArray(DATA);
  setBBSeriesFromArray(DATA, null);
  calcEMAs();

  candleSeries.setData(DATA);
  const maxIdx = Math.max(0, DATA.length-2);
  const raw = detectSignalsMain(maxIdx);
  const gated = filterSignalsByJetDetectorFinal(raw);
  SIGNALS = gated;
  applyMarkers();

  if(gated.length){
    const last = gated[gated.length-1];
    __engineLastByTf[String($("tf").value||"").toLowerCase()] = last;
    ensureGlobalSignal(last);

    const key = (last.symbol||"") + "|" + (last.tf||"") + "|" + (last.time||"") + "|" + (last.dir||"");
    if(key !== __lastNotifiedKey){
      __lastNotifiedKey = key;

      const allowTf = (!SIGNAL_FILTER_TF) || (String(last.tf||"") === String(SIGNAL_FILTER_TF||""));
      if(allowTf && (last.dir==="buy" || last.dir==="sell")){
        playBeep();
        const html = buildSignalToastHtml(last, NOTIF_BG_COLOR, NOTIF_FONT_COLOR);
        showToast(html, "center", NOTIF_HOLD_SECONDS);
      }
    }
  }

  renderSignals();
  renderIndicatorHistory();
  __renderAiVsEngine();
}

/* ============================
   Load data
   ============================ */
function setTfLabels(){
  if($("tfLabel1")) $("tfLabel1").textContent = $("tf").value;
  if($("tfLabel2")) $("tfLabel2").textContent = $("tf2").value;
  if($("tfLabel3")) $("tfLabel3").textContent = $("tf3").value;
  if($("tfLabel4")) $("tfLabel4").textContent = $("tf4").value;
  if($("tfLabel5")) $("tfLabel5").textContent = $("tf5").value;
}

async function loadData(){
  setTfLabels();
  const sel = $("symbol").value || "";
  const tf1 = $("tf").value;
  const tf2 = $("tf2").value;
  const tf3 = $("tf3").value;
  const tf4 = $("tf4").value;
  const tf5 = $("tf5").value;

  closeDerivWS();
  closeBinanceWS();
  clearBundle(chart2Bundle); clearBundle(chart3Bundle); clearBundle(chart4Bundle); clearBundle(chart5Bundle);
  DATA = []; SIGNALS = [];
  candleSeries.setData([]); candleSeries.setMarkers([]);
  bbMid.setData([]); bbUpper.setData([]); bbLower.setData([]);
  ema1Series.setData([]); ema2Series.setData([]);

  setStatus("Loading…");

  const isBinanceSpot = sel.startsWith("bn:");
  const isBinanceFut  = sel.startsWith("bf:");

  try{
    if(isBinanceSpot || isBinanceFut){
      const symbol = sel.split(":")[1];
      const market = isBinanceFut ? "futures" : "spot";

      const interval1 = toBinanceInterval(tf1);
      const interval2 = toBinanceInterval(tf2);
      const interval3 = toBinanceInterval(tf3);
      const interval4 = toBinanceInterval(tf4);
      const interval5 = toBinanceInterval(tf5);

      const kl = await fetchBinanceKlines(symbol, interval1, 600, market);
      DATA = kl.map(k=>({
        time: Math.floor(Number(k[0])/1000),
        open: Number(k[1]), high:Number(k[2]), low:Number(k[3]), close:Number(k[4])
      })).filter(x=>isFinite(x.time)&&isFinite(x.open)&&isFinite(x.close));
      candleSeries.setData(DATA);

      const [kl2,kl3,kl4,kl5] = await Promise.all([
        fetchBinanceKlines(symbol, interval2, 600, market).catch(()=>[]),
        fetchBinanceKlines(symbol, interval3, 600, market).catch(()=>[]),
        fetchBinanceKlines(symbol, interval4, 600, market).catch(()=>[]),
        fetchBinanceKlines(symbol, interval5, 600, market).catch(()=>[])
      ]);
      chart2Bundle.data = kl2.map(k=>({time:Math.floor(Number(k[0])/1000),open:+k[1],high:+k[2],low:+k[3],close:+k[4]}));
      chart3Bundle.data = kl3.map(k=>({time:Math.floor(Number(k[0])/1000),open:+k[1],high:+k[2],low:+k[3],close:+k[4]}));
      chart4Bundle.data = kl4.map(k=>({time:Math.floor(Number(k[0])/1000),open:+k[1],high:+k[2],low:+k[3],close:+k[4]}));
      chart5Bundle.data = kl5.map(k=>({time:Math.floor(Number(k[0])/1000),open:+k[1],high:+k[2],low:+k[3],close:+k[4]}));

      chart2Bundle.series.setData(chart2Bundle.data);
      chart3Bundle.series.setData(chart3Bundle.data);
      chart4Bundle.series.setData(chart4Bundle.data);
      chart5Bundle.series.setData(chart5Bundle.data);

      renderStrategyToBundle(chart2Bundle, chart2Bundle.data, sel, tf2);
      renderStrategyToBundle(chart3Bundle, chart3Bundle.data, sel, tf3);
      renderStrategyToBundle(chart4Bundle, chart4Bundle.data, sel, tf4);
      renderStrategyToBundle(chart5Bundle, chart5Bundle.data, sel, tf5);

      recomputeAllSignals();

      startBinanceKlineStream(symbol, interval1, market);
      startBinanceKlineStreamToBundle(chart2Bundle, symbol, interval2, tf2, market);
      startBinanceKlineStreamToBundle(chart3Bundle, symbol, interval3, tf3, market);
      startBinanceKlineStreamToBundle(chart4Bundle, symbol, interval4, tf4, market);
      startBinanceKlineStreamToBundle(chart5Bundle, symbol, interval5, tf5, market);

      setStatus(isBinanceFut ? "Binance Futures Live" : "Binance Spot Live");
    } else {
      const symbol = sel.split(":")[1] || "R_25";
      const candles = await derivFetchCandles(symbol, tf1, 600);
      DATA = candles.map(c=>({
        time: Number(c.epoch),
        open: Number(c.open), high:Number(c.high), low:Number(c.low), close:Number(c.close)
      })).filter(x=>isFinite(x.time)&&isFinite(x.open)&&isFinite(x.close));
      candleSeries.setData(DATA);

      chart2Bundle.data = DATA.slice();
      chart3Bundle.data = DATA.slice();
      chart4Bundle.data = DATA.slice();
      chart5Bundle.data = DATA.slice();
      chart2Bundle.series.setData(chart2Bundle.data);
      chart3Bundle.series.setData(chart3Bundle.data);
      chart4Bundle.series.setData(chart4Bundle.data);
      chart5Bundle.series.setData(chart5Bundle.data);

      renderStrategyToBundle(chart2Bundle, chart2Bundle.data, sel, tf2);
      renderStrategyToBundle(chart3Bundle, chart3Bundle.data, sel, tf3);
      renderStrategyToBundle(chart4Bundle, chart4Bundle.data, sel, tf4);
      renderStrategyToBundle(chart5Bundle, chart5Bundle.data, sel, tf5);

      recomputeAllSignals();
      startDerivLive(symbol, tf1);
      setStatus("Deriv Live");
    }
  }catch(e){
    console.warn(e);
    setStatus("Load failed");
    showToast("Load failed: " + (e && e.message ? e.message : "unknown"), "center", 5);
  }
}

/* ============================
   Init markets + UI events
   ============================ */
function bindUi(){
  fillDerivGroupOptions();
  initBinanceMarkets();

  $("load").addEventListener("click", ()=> loadData());
  $("symbol").addEventListener("change", ()=> loadData());
  for(const id of ["tf","tf2","tf3","tf4","tf5"]){
    $(id).addEventListener("change", ()=> loadData());
  }
  if($("sigTfFilter")) $("sigTfFilter").addEventListener("change", ()=>{
    renderSignals();
    renderIndicatorHistory();
  });
}

bindUi();
setTimeout(()=>{ try{ loadData(); }catch(_){ } }, 300);
</script>
</body>
</html>
