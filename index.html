<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BinaryTools UI – Deriv Volatility Chart (Fixed)</title>

  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <!-- Lightweight Charts -->
  <link rel="preconnect" href="https://unpkg.com"/>
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    /* =================== AURORA NEON THEME (Colors & Design only) =================== */
    :root{
      --bg-0:#070910;
      --bg-1:#0a0f1c;
      --bg-2:#0d1424;
      --panel:#101a2c;
      --panel-2:#0c1629;
      --ink:#e9f1ff;
      --muted:#9eb4d6;
      --line:#172842;
      --accent:#9b5cff;      /* violet */
      --accent-2:#06c1dc;    /* cyan */
      --accent-3:#ffd166;    /* warm highlight */
      --ok:#10d07a;
      --bad:#ff4d6d;
      --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02);
      --glass: rgba(13,22,39,.55);
      --glass-bd: rgba(255,255,255,.06);
    }

    /* Global */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(155,92,255,.12), transparent 60%),
        radial-gradient(1200px 600px at 90% 100%, rgba(6,193,220,.10), transparent 60%),
        linear-gradient(180deg,var(--bg-0),var(--bg-1) 40%,var(--bg-2));
      color: var(--ink);
    }
    a { color: inherit; text-decoration: none; }

    /* Layout */
    .container { display: flex; height: 100vh; }

    /* (Sidebar removed; we reuse .sidebar-item styles for the top menu buttons) */
    .sidebar-item {
      padding: 0.85rem 1rem; display: flex; align-items: center; gap: 0.85rem;
      color: #b7c6e6; cursor: pointer; transition: background .2s, color .2s, transform .2s;
      border-left: 3px solid transparent;
      border-radius: 10px;
    }
    .sidebar-item i { width: 20px; text-align: center; opacity: .9; }
    .sidebar-item:hover {
      background: rgba(155,92,255,.10);
      color: #ffffff;
      transform: translateY(-1px);
      border-left-color: var(--accent);
    }
    .sidebar-item.active {
      background: linear-gradient(90deg, rgba(155,92,255,.22), rgba(6,193,220,.18));
      color: #ffffff;
      border-left-color: var(--accent-2);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }

    .main { flex: 1; display: flex; flex-direction: column; }

    /* Topbar — WHITE base (gradient is applied inline via JS for precise stop) */
    .topbar {
      height: 56px;
      background: #ffffff; /* base; JS will paint yellow-from-right → up to 'p' */
      color: #0f172a;
      display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; font-size: 0.95rem;
      border-bottom: 1px solid rgba(15,23,42,.12);
      position: sticky; top: 0; z-index: 50;
    }
    .topbar .left, .topbar .right { display: flex; align-items: center; gap: 0.85rem; }
    .topbar i { color: #0f172a; text-shadow: none; }
    #top-user { color:#0f172a; font-weight:700; }
    #loginLink { color: #0f766e; font-weight:600; }
    .metric { color:#0f172a; font-weight:600; }
    .metric .label { font-weight:600; opacity:.7; margin-right:.25rem }
    .dot { opacity:.35; }

    /* brand tweaks */
    #brand-name{
      font-weight:700; letter-spacing:.2px; color:#0f172a;
      /* Move slightly to the left as requested */
      margin-left:-6px;
    }

    /* New horizontal top menu (side buttons moved here) */
    .topmenu {
      height: 52px;
      display: flex; align-items: center; gap: .25rem; padding: .5rem .75rem;
      background:
        linear-gradient(90deg, rgba(155,92,255,.12), rgba(6,193,220,.12)),
        linear-gradient(180deg, rgba(16,26,44,.75), rgba(10,18,34,.75));
      border-bottom: 1px solid var(--glass-bd);
      backdrop-filter: blur(6px);
      position: sticky; top: 56px; z-index: 49;
      box-shadow: var(--shadow);
      overflow-x: auto;
    }
    .topmenu .sidebar-item { border-left: 0; padding: .6rem .85rem; white-space: nowrap; }

    .content { flex: 1; overflow-y: auto; padding: 1rem; }
    .hidden { display: none; }

    .content h2, .content h3 {
      color: var(--accent-3);
      margin-bottom: 0.6rem;
      text-shadow: 0 1px 0 rgba(0,0,0,.3);
    }

    /* Stats cards */
    .stats { display: flex; gap: 1rem; margin-bottom: 1rem; }
    .card {
      background: var(--glass);
      border: 1px solid var(--glass-bd);
      box-shadow: var(--shadow);
      flex: 1; padding: 1rem;
      border-radius: 14px;
      position: relative;
      overflow: hidden;
    }
    .card::before{
      content:""; position:absolute; inset:-1px;
      background: radial-gradient(600px 140px at -10% -20%, rgba(155,92,255,.14), transparent 60%);
      pointer-events:none;
    }
    .card h4 { margin-bottom: 0.5rem; color: #cbd9ff; letter-spacing:.2px }
    .card p { font-size: 1.25rem; text-shadow: 0 0 12px rgba(155,92,255,.15); }
    .green { color: var(--ok); }
    .red { color: var(--bad); }

    /* ===== Scoped styles for the Deriv Chart App (visual only) ===== */
    #derivChartApp {
      --bg:#0b1120; --panel:var(--panel); --panel2:var(--panel-2); --ink:var(--ink); --muted:var(--muted);
      --line:var(--line); --up:#10d07a; --down:#ff4d6d;
      background:
        radial-gradient(900px 400px at 80% 0%, rgba(6,193,220,.10), transparent 60%),
        radial-gradient(900px 400px at 0% 100%, rgba(155,92,255,.12), transparent 60%),
        linear-gradient(180deg,var(--bg),#0a1222 30%,#080d1a);
      color: var(--ink);
      border: 1px solid var(--glass-bd);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    #derivChartApp .chartbar{
      position: sticky; top: 0; z-index: 2;
      background:
        linear-gradient(90deg, rgba(155,92,255,.16), rgba(6,193,220,.16)),
        rgba(10,18,34,.82);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--glass-bd);
      display: flex; gap: 14px; align-items: center; padding: 10px 14px;
    }
    #derivChartApp .chartbar h1{
      font-size:16px;margin:0 10px 0 0;letter-spacing:.25px;color:#ffffff;
      text-shadow: 0 0 18px rgba(155,92,255,.35);
    }
    #derivChartApp .spacer{flex:1}
    #derivChartApp .ctrl{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    #derivChartApp .hint{font-size:12px;color:var(--muted)}

    #derivChartApp select, #derivChartApp button{
      background: linear-gradient(180deg, rgba(20,33,56,.9), rgba(15,26,46,.9));
      color: var(--ink);
      border: 1px solid var(--glass-bd);
      border-radius:12px;
      padding:8px 12px;font:inherit;outline:none; cursor:pointer;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03), 0 4px 16px rgba(0,0,0,.25);
      transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
    }
    #derivChartApp select:focus, #derivChartApp button:focus{
      border-color: rgba(6,193,220,.45);
      box-shadow: 0 0 0 3px rgba(6,193,220,.18);
    }
    #derivChartApp button{
      background:
        linear-gradient(90deg, rgba(155,92,255,.25), rgba(6,193,220,.25)),
        linear-gradient(180deg, rgba(24,40,68,.95), rgba(16,30,54,.95));
    }
    #derivChartApp button:hover{ transform: translateY(-1px); }

    #derivChartApp .wrap{height: 60vh; padding: 12px;}
    #derivChartApp .cardX{
      height:100%;
      background:
        radial-gradient(900px 300px at 100% 0%, rgba(6,193,220,.10), transparent 60%),
        radial-gradient(900px 300px at 0% 100%, rgba(155,92,255,.12), transparent 60%),
        linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--glass-bd);
      border-radius:16px; position:relative; overflow:hidden;
      box-shadow: var(--shadow);
    }
    #derivChartApp .cardX .slot{position:absolute; inset:0}

    #derivChartApp .pill{
      font-size:12px;padding:6px 10px;border:1px solid var(--glass-bd);
      border-radius:999px;color:#d7e6ff;
      background: linear-gradient(180deg, rgba(20,33,56,.75), rgba(13,23,41,.75));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }

    /* Icon bar (top-right) */
    #derivChartApp .icon-bar{
      position:absolute;top:10px;right:10px;z-index:3;display:flex;gap:10px
    }
    #derivChartApp .icon-bar a{
      width:36px;height:36px;display:grid;place-items:center;border-radius:12px;
      background: linear-gradient(180deg, rgba(20,33,56,.7), rgba(15,26,46,.7));
      border:1px solid var(--glass-bd);backdrop-filter:blur(6px);
      text-decoration:none;transition:.18s transform, .18s box-shadow;
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
    }
    #derivChartApp .icon-bar a:hover{
      transform:translateY(-2px);
      box-shadow: 0 10px 24px rgba(155,92,255,.25);
    }
    #derivChartApp .icon-bar svg{width:18px;height:18px;fill:#d8e6ff;filter: drop-shadow(0 0 8px rgba(155,92,255,.35));}
  </style>
</head>
<body>
  <div class="container">
    <!-- (Sidebar removed) -->

    <!-- Main Content -->
    <section class="main">
      <!-- Topbar (WHITE base; JS paints yellow-from-right → up to 'p') -->
      <header class="topbar" id="topbar">
        <div class="left" id="brand-left">
          <!-- PNG logo -->
          <img src="https://iili.io/Kw8ik5g.th.jpg" alt="logo" style="height:28px; width:auto; display:block;"/>
          <!-- derivesup name (moved slightly left) -->
          <span id="brand-name">derivesup</span>
        </div>
        <div class="right" id="top-right">
          <span id="top-user">Your Name</span>
          <span class="dot">•</span>
          <span class="metric" id="top-balance"><span class="label">Bal:</span> —</span>
          <span class="dot">•</span>
          <span class="metric" id="top-cr"><span class="label">CR:</span> —</span>
          <span class="dot">•</span>
          <span class="metric" id="top-pnl"><span class="label">PnL:</span> —</span>
          <a id="loginLink" class="green" href="#" title="Login to Deriv">Login</a>
          <i class="fas fa-caret-down"></i>
        </div>
      </header>

      <!-- New Horizontal Top Menu (icons/logos changed) -->
      <nav class="topmenu">
        <div class="sidebar-item active" data-section="dashboard"><i class="fas fa-house"></i> Dashboard</div>
        <div class="sidebar-item" data-section="freebots"><i class="fas fa-microchip"></i>5 Confirmations Manual Strategies</div>
        <div class="sidebar-item" data-section="botbuilder"><i class="fas fa-screwdriver-wrench"></i>Analyzer Tool</div>
        <div class="sidebar-item" data-section="tools"><i class="fas fa-wand-magic-sparkles"></i>5 Confirmations Auto Bot</div>
        <div class="sidebar-item" data-section="signals"><i class="fas fa-bolt"></i>MT 5 Bulk Trading tool</div>
        <div class="sidebar-item" data-section="charts"><i class="fas fa-chart-area"></i> DeriveSup Signal</div>
        <div class="sidebar-item" data-section="auto-analyzer"><i class="fas fa-gears"></i>Money Management Plan</div>
      </nav>

      <!-- Content Area -->
      <div class="content">
        <div id="content-dashboard">
          <h2>Deriv Dashboard</h2>

          <div class="stats">
            <div class="card"><h4>Balance</h4><p id="balance" class="green">—</p></div>
            <div class="card"><h4>CR Number</h4><p id="cr">—</p></div>
            <div class="card"><h4>Daily PnL</h4><p id="pnl" class="">—</p></div>
          </div>

          <!-- ======= Deriv Volatility Chart in the middle ======= -->
          <div id="derivChartApp" aria-label="AI Signal Studio — Deriv Volatility">
            <div class="chartbar">
              <h1>Deriv Volatility</h1>
              <div class="ctrl">
                <label class="hint">Volatility</label>
                <select id="vol">
                  <option value="R_10">Volatility 10</option>
                  <option value="R_25">Volatility 25</option>
                  <option value="R_50" selected>Volatility 50</option>
                  <option value="R_75">Volatility 75</option>
                  <option value="R_100">Volatility 100</option>
                  <option value="R_10S">Volatility 10 (1s)</option>
                  <option value="R_25S">Volatility 25 (1s)</option>
                  <option value="R_50S">Volatility 50 (1s)</option>
                  <option value="R_75S">Volatility 75 (1s)</option>
                  <option value="R_100S">Volatility 100 (1s)</option>
                </select>

                <label class="hint">TF</label>
                <select id="tf">
                  <option value="1m">1m</option>
                  <option value="5m" selected>5m</option>
                  <option value="15m">15m</option>
                  <option value="1h">1h</option>
                  <option value="4h">4h</option>
                  <option value="1d">1d</option>
                </select>

                <button id="reload">Load</button>
              </div>

              <div class="spacer"></div>
              <div class="ctrl">
                <span class="pill" id="status">Booting…</span>
              </div>
            </div>

            <div class="wrap">
              <div class="cardX" id="main">
                <div class="icon-bar"></div>
                <div class="slot" id="c-main"></div>
              </div>
            </div>
          </div>
          <!-- ======= /Chart ======= -->
        </div>

        <!-- Other sections (kept) -->
        <div id="content-freebots" class="hidden"><h3>Free Bots</h3></div>
        <div id="content-botbuilder" class="hidden"><h3>Bot Builder</h3></div>
        <div id="content-manual" class="hidden"><h3>Manual Analyzer</h3></div>
        <div id="content-tools" class="hidden"><h3>Analysis Tools</h3></div>
        <div id="content-signals" class="hidden"><h3>Signals</h3></div>
        <div id="content-charts" class="hidden"><h3>Charts</h3></div>
        <div id="content-auto-analyzer" class="hidden"><h3>Auto Analyzer</h3></div>
        <div id="content-smart" class="hidden"><h3>Smart Auto</h3></div>
      </div>
    </section>
  </div>

  <script>
    /* ===================== Topbar yellow-from-right → up to 'p' mix ===================== */
    (function paintTopbarGradient(){
      const topbar = document.getElementById('topbar');
      const brand  = document.getElementById('brand-name');

      function apply(){
        if(!topbar || !brand) return;
        const tb  = topbar.getBoundingClientRect();
        const br  = brand.getBoundingClientRect();
        // Right edge of the word "derivesup" ≈ at the "p" letter
        const stop = Math.round(br.right - tb.left);   // px from left of topbar to the 'p' edge
        const blend = 28; // width of the white↔yellow mix zone

        // White (left) → mix near 'p' → Yellow (right)
        topbar.style.background =
          `linear-gradient(90deg,
            #ffffff 0,
            #ffffff ${Math.max(0, stop - blend)}px,
            #fff7d1 ${stop}px,
            #ffd166 ${stop + blend}px,
            #ffd166 100%)`;
      }

      // initial + on resize/scroll/font reflow
      window.addEventListener('load', apply);
      window.addEventListener('resize', apply);
      new ResizeObserver(apply).observe(document.body);
      // slight defer for font metrics
      setTimeout(apply, 100);
    })();

    /* ===================== Deriv OAuth (APP ID: 106142) ===================== */
    const APP_ID = '106142';
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;

    (function handleOAuthCallback() {
      const params = new URLSearchParams(window.location.search);
      if (params.has('token1') && params.has('acct1')) {
        localStorage.setItem('deriv_token', params.get('token1'));
        localStorage.setItem('deriv_loginid', params.get('acct1'));
        history.replaceState(null, '', REDIRECT_URI);
      }
    })();

    const TOKEN = localStorage.getItem('deriv_token');

    // login link
    const loginLink = document.getElementById('loginLink');
    loginLink.onclick = (e)=>{ e.preventDefault(); window.location.href = OAUTH_URL; };

    // Helper: format USD
    const fmtUSD = (n)=> (Number(n)||0).toFixed(2) + ' USD';

    // Topbar refs
    const elTopUser   = document.getElementById('top-user');
    const elTopBal    = document.getElementById('top-balance');
    const elTopCR     = document.getElementById('top-cr');
    const elTopPnL    = document.getElementById('top-pnl');

    // Dashboard cards
    const elBalCard   = document.getElementById('balance');
    const elCRCard    = document.getElementById('cr');
    const elPNLCard   = document.getElementById('pnl');

    if (TOKEN) {
      const wsAcct = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`);
      wsAcct.onopen = ()=> wsAcct.send(JSON.stringify({ authorize: TOKEN }));

      wsAcct.onmessage = (ev)=>{
        const data = JSON.parse(ev.data);

        if(data.msg_type === 'authorize'){
          const auth = data.authorize||{};
          const fullName = auth.fullname || auth.loginid || 'User';
          const loginid  = auth.loginid || '-';
          const balStr   = fmtUSD(auth.balance);

          elTopUser.textContent  = fullName;
          elTopBal.innerHTML     = `<span class="label">Bal:</span> ${balStr}`;
          elTopCR.innerHTML      = `<span class="label">CR:</span> ${loginid}`;
          loginLink.style.display = 'none';

          elBalCard.textContent  = balStr;
          elCRCard.textContent   = loginid;

          const now = new Date();
          const utcMidnight = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())/1000;
          const nowEpoch = Math.floor(Date.now()/1000);
          wsAcct.send(JSON.stringify({
            profit_table: 1,
            description: 1,
            date_from: utcMidnight,
            date_to: nowEpoch,
            limit: 500
          }));
        }

        if(data.msg_type === 'profit_table' && data.profit_table){
          const rows = (data.profit_table.transactions || []);
          const sum = rows.reduce((a,r)=> a + (Number(r.profit)||0), 0);
          const signCls = sum >= 0 ? 'green' : 'red';
          const pnlStr = (Number(sum).toFixed(2)) + ' USD';

          elTopPnL.innerHTML = `<span class="label">PnL:</span> ${pnlStr}`;
          elTopPnL.classList.remove('green','red');
          elTopPnL.classList.add(signCls);

          elPNLCard.textContent = (sum>=0?'+':'') + pnlStr.replace(' USD','');
          elPNLCard.classList.remove('green','red');
          elPNLCard.classList.add(signCls);
        }

        if(data.error){
          console.error(data.error);
        }
      };
    }

    /* ===================== Top menu routing ===================== */
    document.querySelectorAll('.sidebar-item').forEach(el => {
      el.onclick = () => {
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('[id^="content-"]').forEach(c => c.classList.add('hidden'));
        document.getElementById('content-' + el.dataset.section).classList.remove('hidden');
      };
    });

    /* ===================== Deriv Volatility Chart ===================== */
    (function initDerivChart(){
      const $ = (id)=>document.getElementById(id);
      const els = { vol:$('vol'), tf:$('tf'), status:$('status') };
      const setStatus = (t)=> els.status.textContent = t;

      const MARKET_WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
      let WS = null, DATA = [], OLDEST_EPOCH=null, LOADING_OLD=false, liveSubId=null;

      const GRAN = { '1m':60, '5m':300, '15m':900, '1h':3600, '4h':14400, '1d':86400 };
      const mapSymbol = (sel)=> sel.endsWith('S') ? sel.replace('S','_1s') : sel;

      const elMain = document.getElementById('c-main');
      const chart = LightweightCharts.createChart(elMain, {
        layout:{background:{type:'solid',color:'transparent'},textColor:'#cfe3ff'},
        grid:{vertLines:{color:'#0e1a28'},horzLines:{color:'#0e1a28'}},
        rightPriceScale:{borderColor:'#223246'},
        timeScale:{borderColor:'#223246', rightOffset: 20, barSpacing: 8},
        crosshair:{mode:0},
      });
      const sCandle = chart.addCandlestickSeries({
        upColor:'#16a34a',downColor:'#ef4444',
        borderUpColor:'#16a34a',borderDownColor:'#ef4444',
        wickUpColor:'#16a34a',wickDownColor:'#ef4444'
      });
      const resize=()=>chart.applyOptions({width:elMain.clientWidth,height:elMain.clientHeight});
      new ResizeObserver(resize).observe(elMain); resize();

      function closeWS(){
        try{ if(WS){ WS.onmessage=null; WS.onclose=null; WS.onerror=null; WS.close(); } }catch(_){}
        WS=null;
      }
      function openWS(){
        closeWS();
        WS = new WebSocket(MARKET_WS_URL);
        WS.onopen = ()=> setStatus('Connected');
        WS.onerror = ()=> setStatus('Socket error');
        WS.onclose = ()=> setStatus('Disconnected');
        WS.onmessage = handleWSMessage;
      }
      function sendWS(obj){
        if(WS && WS.readyState===1){ WS.send(JSON.stringify(obj)); }
        else {
          openWS();
          const iv = setInterval(()=>{
            if(WS && WS.readyState===1){
              clearInterval(iv);
              WS.send(JSON.stringify(obj));
            }
          },150);
        }
      }

      function requestCandles(symbol, gran, count=1000, end='latest'){
        sendWS({ ticks_history: symbol, style:'candles', granularity: gran, count, end });
      }
      function subscribeLive(symbol, gran){
        if(liveSubId){ sendWS({ forget: liveSubId }); liveSubId = null; }
        sendWS({ ticks_history: symbol, style:'candles', granularity: gran, count:1, end:'latest', subscribe:1 });
      }

      function handleWSMessage(e){
        try{
          const msg = JSON.parse(e.data);

          if(msg.msg_type === 'candles' && Array.isArray(msg.candles)){
            const arr = msg.candles.map(c=>({ time:c.epoch, open:+c.open, high:+c.high, low:+c.low, close:+c.close }));
            if(!DATA.length || (arr.length && arr[arr.length-1].time > (DATA[DATA.length-1]?.time||0))){
              DATA = arr;
            }else{
              DATA = arr.concat(DATA);
            }
            OLDEST_EPOCH = DATA[0]?.time ?? OLDEST_EPOCH;
            sCandle.setData(DATA);
            queueMicrotask(()=> chart.timeScale().scrollToPosition(-2, false));
            setStatus('History loaded');
          }

          if(msg.msg_type === 'ohlc' && msg.ohlc){
            const k = msg.ohlc;
            const t = +k.open_time;
            const bar = { time:t, open:+k.open, high:+k.high, low:+k.low, close:+k.close };
            const lastT = DATA[DATA.length-1]?.time;
            if(lastT === t){
              DATA[DATA.length-1] = bar;
              sCandle.update(bar);
            }else if(!lastT || t > lastT){
              DATA.push(bar);
              if(DATA.length>5000) DATA.shift();
              sCandle.update(bar);
            }
            setStatus(`Live: ${els.vol.value} • ${els.tf.value}`);
          }

          if(msg.subscription && msg.subscription.id){
            liveSubId = msg.subscription.id;
          }

          if(msg.error){
            console.error(msg.error);
            setStatus('API error');
            alert('Deriv API error: ' + (msg.error.message||'Unknown'));
          }
        }catch(err){ console.error(err); }
      }

      function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
      const watchBackfill = debounce(()=>{
        const range = chart.timeScale().getVisibleLogicalRange?.();
        if(!range || LOADING_OLD) return;
        if(range.from !== undefined && range.from < 20 && OLDEST_EPOCH){
          LOADING_OLD = true;
          const symbol = mapSymbol(els.vol.value);
          const gran = GRAN[els.tf.value];
          requestCandles(symbol, gran, 1000, String(OLDEST_EPOCH - 1));
          setTimeout(()=>{ LOADING_OLD = false; }, 400);
        }
      }, 150);
      chart.timeScale().subscribeVisibleLogicalRangeChange?.(watchBackfill);

      async function loadAll(){
        try{
          setStatus('Loading…');
          const symbol = mapSymbol(els.vol.value);
          const gran = GRAN[els.tf.value];

          if(!WS || WS.readyState!==1) openWS();

          DATA = []; OLDEST_EPOCH = null; sCandle.setData([]);

          requestCandles(symbol, gran, 1000, 'latest');
          subscribeLive(symbol, gran);
        }catch(err){
          console.error(err);
          setStatus('Error loading');
          alert('Failed to load Deriv candles. Check network.');
        }
      }

      document.getElementById('reload').addEventListener('click', loadAll);
      els.tf.addEventListener('change', loadAll);
      els.vol.addEventListener('change', loadAll);

      openWS();
      loadAll();
    })();
  </script>
</body>
</html>
